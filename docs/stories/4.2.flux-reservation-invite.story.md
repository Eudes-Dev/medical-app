# Story 4.2: Flux de Réservation "Invité"

## Status
Draft

## Story
**As a** patient invité,
**I want** finaliser ma réservation en fournissant mes coordonnées minimales,
**so that** je puisse obtenir un rendez-vous rapidement sans créer de compte.

## Acceptance Criteria
1. Le formulaire invité contient: Prénom, Nom, Téléphone, Email
2. La validation Zod vérifie tous les champs côté client et serveur
3. Si l'email existe déjà en base, le RDV est lié au patient existant
4. Si l'email est nouveau, un nouveau patient est créé automatiquement
5. Un écran de succès affiche le récapitulatif du rendez-vous
6. Un toast de confirmation s'affiche après la réservation
7. Un cookie temporaire permet au patient de revoir son récapitulatif
8. Le praticien voit le nouveau RDV apparaître dans son agenda

## Tasks / Subtasks
- [ ] Task 1: Composant formulaire invité (AC: 1)
  - [ ] Créer `/components/booking/GuestForm.tsx`
  - [ ] Champs: firstName, lastName, phone, email
  - [ ] Utiliser Shadcn UI (Input, Label, Button)
  - [ ] Design épuré et mobile-first
- [ ] Task 2: Schéma de validation Zod (AC: 2)
  - [ ] Créer `/lib/validations/booking.ts`
  - [ ] Définir `guestBookingSchema`:
    - firstName: string, min 2 caractères
    - lastName: string, min 2 caractères
    - phone: string, format téléphone (10 chiffres)
    - email: string, format email valide
    - slotDateTime: date, dans le futur
- [ ] Task 3: Server Action - Réservation (AC: 3, 4, 8)
  - [ ] Créer `/app/(public)/[cabinet-slug]/book/actions.ts`
  - [ ] Implémenter `createGuestBooking(data)`:
    ```
    1. Valider les données avec Zod
    2. Vérifier si l'email existe → findUnique patient
    3. Si existe: utiliser patient.id
    4. Si nouveau: créer patient avec upsert
    5. Vérifier conflit de créneau (dernière vérification)
    6. Créer l'appointment avec status PENDING
    7. Retourner { success, appointmentId }
    ```
- [ ] Task 4: Écran de succès (AC: 5)
  - [ ] Créer `/app/(public)/[cabinet-slug]/book/success/page.tsx`
  - [ ] Afficher:
    - Message de confirmation
    - Date et heure du RDV
    - Nom du cabinet
    - Instructions (arriver 10 min avant, etc.)
  - [ ] Bouton "Retour à l'accueil"
- [ ] Task 5: Feedback utilisateur (AC: 6)
  - [ ] Afficher toast succès après réservation
  - [ ] Afficher toast erreur si conflit de créneau
  - [ ] Rediriger vers page succès après confirmation
- [ ] Task 6: Cookie de session (AC: 7)
  - [ ] Créer un cookie `booking_token` avec l'appointmentId chiffré
  - [ ] Durée: 24 heures
  - [ ] Permettre l'accès à `/book/success` avec ce cookie
  - [ ] Afficher les détails du RDV depuis le cookie
- [ ] Task 7: Intégration tunnel complet
  - [ ] Étape 1: Sélection créneau (story 4.1)
  - [ ] Étape 2: Formulaire invité (ce composant)
  - [ ] Étape 3: Confirmation (écran succès)
  - [ ] Stepper visuel pour indiquer la progression

## Dev Notes

### Expérience "Invité" (Guest Flow)
1. Le patient ne voit jamais d'écran de "Login" pour prendre RDV
2. Saisie simplifiée: Prénom, Nom, Téléphone, Email
3. Après validation, un cookie temporaire permet au patient de voir son récapitulatif sans compte
[Source: docs/front-end-spec.md - Section 5]

### PRD - Critères d'Acceptation
- Le patient reçoit une confirmation visuelle après validation du formulaire
[Source: docs/prd.md - Section 4]

### PRD - User Stories
- US.2: En tant que patient (invité), je veux réserver un créneau en 3 clics sans créer de compte.
[Source: docs/prd.md - Section 3]

### Stratégie de Validation (Zod)
- **Côté Client**: Feedback immédiat sous les champs de saisie (ex: format email, téléphone obligatoire)
- **Côté Serveur**: Double vérification dans les Next.js Server Actions avant insertion en base
[Source: docs/front-end-spec.md - Section 4]

### Design System
- Couleur principale: Blue-600 (#2563eb) pour le bouton de validation
- Couleur succès: Emerald-500 pour l'écran de confirmation
- Couleur erreur: Rose-500 pour les messages de validation
[Source: docs/front-end-spec/2-design-system-ui-components.md]

### Logique upsert patient
```typescript
const findOrCreatePatient = async (data: GuestData) => {
  const existingPatient = await prisma.patient.findUnique({
    where: { email: data.email },
  })
  
  if (existingPatient) {
    return existingPatient
  }
  
  return prisma.patient.create({
    data: {
      firstName: data.firstName,
      lastName: data.lastName,
      phone: data.phone,
      email: data.email,
    },
  })
}
```

### Sécurité du cookie
```typescript
import { cookies } from 'next/headers'
import { SignJWT, jwtVerify } from 'jose'

const secret = new TextEncoder().encode(process.env.JWT_SECRET)

export async function setBookingCookie(appointmentId: string) {
  const token = await new SignJWT({ appointmentId })
    .setProtectedHeader({ alg: 'HS256' })
    .setExpirationTime('24h')
    .sign(secret)
  
  cookies().set('booking_token', token, {
    httpOnly: true,
    secure: process.env.NODE_ENV === 'production',
    maxAge: 60 * 60 * 24, // 24 heures
  })
}
```

### Testing
- Tester la réservation avec un nouvel email (création patient)
- Tester la réservation avec un email existant (liaison patient)
- Vérifier la validation des champs (email invalide, téléphone invalide)
- Tester le cas de conflit de créneau (réservé entre-temps)
- Vérifier l'affichage de l'écran de succès
- Tester l'accès au récapitulatif via le cookie

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-25 | 1.0 | Création initiale de la story | SM Agent (Bob) |
