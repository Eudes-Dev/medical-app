# Story 1.3: Authentification Praticien

## Status
Ready for Review üîç

## Prerequisites
- **Story 1.1**: Initialisation Next.js 16 (doit √™tre compl√©t√©e) - fournit la structure de base, TailwindCSS, Shadcn UI
- **Story 1.2**: Couche de Donn√©es Prisma & Supabase (doit √™tre compl√©t√©e) - fournit la connexion Supabase et le mod√®le User
- **Compte Supabase**: Authentication activ√©e dans le projet Supabase existant

## Story
**As a** praticien,
**I want to** me connecter de mani√®re s√©curis√©e √† mon espace de gestion,
**so that** seul moi puisse acc√©der aux donn√©es de mes patients et √† mon agenda.

## Acceptance Criteria
1. Supabase Auth est configur√© et int√©gr√© au projet avec le package `@supabase/ssr`
2. Une page de login (`/login`) est cr√©√©e avec un formulaire email/mot de passe
3. Le formulaire de login valide les entr√©es avec Zod et react-hook-form
4. La connexion r√©ussie redirige vers `/dashboard`
5. Un middleware Next.js prot√®ge toutes les routes `/dashboard/**`
6. Les utilisateurs non authentifi√©s sont redirig√©s vers `/login`
7. Un bouton de d√©connexion est fonctionnel dans le layout dashboard

## Tasks / Subtasks
- [x] Task 1: Configuration Supabase Auth (AC: 1)
  - [x] Installer `@supabase/supabase-js` et `@supabase/ssr` (NOTE: @supabase/auth-helpers-nextjs est d√©pr√©ci√©)
  - [x] Cr√©er `lib/supabase/client.ts` avec `createBrowserClient()` pour le c√¥t√© navigateur
  - [x] Cr√©er `lib/supabase/server.ts` avec `createServerClient()` pour les Server Components et Server Actions
  - [x] Cr√©er `lib/supabase/middleware.ts` avec `createServerClient()` pour le middleware (gestion cookies)
  - [x] Ajouter les variables d'environnement dans `.env.local`: `NEXT_PUBLIC_SUPABASE_URL`, `NEXT_PUBLIC_SUPABASE_ANON_KEY`
  - [x] Mettre √† jour `.env.example` avec ces nouvelles variables (sans valeurs sensibles)
- [x] Task 2: Page de Login (AC: 2)
  - [x] Cr√©er `/app/(auth)/login/page.tsx` (route group pour les pages d'authentification)
  - [x] Cr√©er `/app/(auth)/layout.tsx` avec un layout centr√© pour les formulaires d'auth
  - [x] Cr√©er le composant `LoginForm` dans `components/auth/login-form.tsx` avec Shadcn UI (Card, Input, Button, Label)
  - [x] Appliquer le design system (couleur principale Blue-600 #2563eb, erreurs Rose-500)
- [x] Task 3: Validation Zod (AC: 3)
  - [x] Installer `zod`, `react-hook-form` et `@hookform/resolvers`
  - [x] Cr√©er le sch√©ma de validation `lib/validations/auth.ts` avec `loginSchema`:
    - email: z.string().email("Email invalide")
    - password: z.string().min(6, "Le mot de passe doit contenir au moins 6 caract√®res")
  - [x] Int√©grer react-hook-form avec zodResolver dans le composant LoginForm
- [x] Task 4: Logique de connexion (AC: 4)
  - [x] Cr√©er une Server Action `signIn` dans `/app/(auth)/login/actions.ts`
  - [x] Impl√©menter `supabase.auth.signInWithPassword()` avec gestion d'erreur
  - [x] Utiliser `redirect()` de next/navigation vers `/dashboard` apr√®s connexion r√©ussie
  - [x] Retourner les erreurs format√©es pour affichage dans le formulaire
- [x] Task 5: Middleware de protection (AC: 5, 6)
  - [x] Cr√©er `middleware.ts` √† la racine du projet
  - [x] Importer le helper de `lib/supabase/middleware.ts` pour la gestion des sessions
  - [x] Configurer le matcher: `matcher: ['/dashboard/:path*']`
  - [x] V√©rifier la session avec `supabase.auth.getUser()` (pas getSession pour la s√©curit√©)
  - [x] Rediriger vers `/login` si `user` est null
  - [x] Rafra√Æchir les tokens expir√©s automatiquement via le middleware
- [x] Task 6: D√©connexion (AC: 7)
  - [x] Cr√©er un composant `components/auth/logout-button.tsx`
  - [x] Cr√©er une Server Action `signOut` dans `/app/(auth)/logout/actions.ts`
  - [x] Impl√©menter `supabase.auth.signOut()`
  - [x] Rediriger vers `/login` apr√®s d√©connexion
  - [x] Int√©grer le bouton dans le layout dashboard existant (`app/dashboard/layout.tsx`)

## Dev Notes

### Architecture de l'Information
- **Espace Priv√© (Dashboard)**: Toutes les routes sous `/dashboard/*` sont prot√©g√©es
  - `/dashboard`: Vue d'ensemble (statistiques du jour, prochains RDV)
  - `/dashboard/calendar`: Agenda interactif (vue jour/semaine/mois)
  - `/dashboard/patients`: Gestion de la base patient
  - `/dashboard/settings`: Configuration du cabinet
- **Page Login**: `/login` (hors espace priv√©, accessible publiquement)
[Source: docs/front-end-spec/1-architecture-de-linformation-sitemap.md]

### Package @supabase/ssr (Important)
Le package `@supabase/auth-helpers-nextjs` est **d√©pr√©ci√©** et remplac√© par `@supabase/ssr` qui est framework-agnostic et con√ßu pour le SSR avec gestion des cookies.

Structure recommand√©e des clients Supabase:
```typescript
// lib/supabase/client.ts - Client c√¥t√© navigateur
import { createBrowserClient } from '@supabase/ssr'

export function createClient() {
  return createBrowserClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  )
}

// lib/supabase/server.ts - Server Components & Server Actions
import { createServerClient } from '@supabase/ssr'
import { cookies } from 'next/headers'
// Utilise les cookies Next.js pour la gestion de session
```

### Relation Supabase Auth <-> User Prisma
- **Supabase Auth** g√®re l'authentification (auth.users) avec UUID comme identifiant
- **User Prisma** stocke le profil praticien dans la table `users`
- La synchronisation se fait via l'UUID: `User.id` = `auth.users.id`
- Note: La cr√©ation du profil User Prisma lors de l'inscription n'est PAS dans le scope de cette story (login seulement)
[Source: docs/stories/1.2.couche-donnees-prisma-supabase.story.md - Task 3]

### Strat√©gie de Validation (Zod)
- **C√¥t√© Client**: Feedback imm√©diat sous les champs de saisie via react-hook-form
- **C√¥t√© Serveur**: Double v√©rification dans les Server Actions avant appel Supabase Auth
[Source: docs/front-end-spec/4-stratgie-de-validation-zod.md]

### Design System
- Utiliser les composants Shadcn UI install√©s: Card, Input, Button (story 1.1)
- Installer le composant Label: `npx shadcn@latest add label`
- Couleur principale pour les boutons: Blue-600 (#2563eb)
- Couleur d'erreur: Rose-500
[Source: docs/front-end-spec/2-design-system-ui-components.md]

### Variables d'environnement requises
Variables √† ajouter dans `.env.local` (en plus de DATABASE_URL et DIRECT_URL existants):
- `NEXT_PUBLIC_SUPABASE_URL`: URL du projet Supabase (ex: https://xxxxx.supabase.co)
- `NEXT_PUBLIC_SUPABASE_ANON_KEY`: Cl√© anonyme Supabase (Dashboard > Settings > API)

### S√©curit√© Middleware
- Toujours utiliser `getUser()` au lieu de `getSession()` dans le middleware
- `getSession()` lit uniquement le cookie sans validation serveur
- `getUser()` valide le token aupr√®s de Supabase Auth (plus s√©curis√©)
[Source: Documentation Supabase SSR]

### Testing
- **Tests manuels requis**:
  - Tester la connexion avec des identifiants valides ‚Üí redirection `/dashboard`
  - Tester le rejet avec des identifiants invalides ‚Üí message d'erreur affich√©
  - Tester la validation Zod ‚Üí erreurs sous les champs (email format, password length)
  - V√©rifier la protection des routes `/dashboard/*` ‚Üí redirection `/login` si non connect√©
  - V√©rifier la d√©connexion ‚Üí redirection `/login` et session supprim√©e
  - Tester l'acc√®s direct √† `/dashboard` sans session ‚Üí redirection `/login`
- **Note**: Les tests automatis√©s seront d√©finis dans le Sprint 5 (story 5.2)

## Dev Agent Record

### File List
| File | Action | Description |
|------|--------|-------------|
| `lib/supabase/client.ts` | Created | Client Supabase c√¥t√© navigateur (Browser) |
| `lib/supabase/server.ts` | Created | Client Supabase c√¥t√© serveur (Server Components/Actions) |
| `lib/supabase/middleware.ts` | Created | Helper pour le middleware avec gestion des cookies |
| `lib/validations/auth.ts` | Created | Sch√©ma de validation Zod pour le login |
| `app/(auth)/layout.tsx` | Created | Layout centr√© pour les pages d'authentification |
| `app/(auth)/login/page.tsx` | Created | Page de connexion praticien |
| `app/(auth)/login/actions.ts` | Created | Server Action signIn pour la connexion |
| `app/(auth)/logout/actions.ts` | Created | Server Action signOut pour la d√©connexion |
| `components/auth/login-form.tsx` | Created | Formulaire de connexion avec validation |
| `components/auth/logout-button.tsx` | Created | Bouton de d√©connexion |
| `components/ui/label.tsx` | Created | Composant Shadcn UI Label (via npx shadcn) |
| `middleware.ts` | Created | Middleware Next.js de protection des routes |
| `app/dashboard/layout.tsx` | Modified | Ajout du bouton de d√©connexion dans le header |
| `.env.local` | Modified | Ajout des variables NEXT_PUBLIC_SUPABASE_* |
| `.env.example` | Created | Template des variables d'environnement |
| `lib/prisma.ts` | Modified | Correction import Prisma 7 (pr√©existant) |
| `package.json` | Modified | Ajout d√©pendances @supabase/ssr, zod, react-hook-form |

### Debug Log References
Aucun probl√®me bloquant rencontr√©.

### Completion Notes
- Tous les Acceptance Criteria sont impl√©ment√©s
- Le linting et TypeScript passent sans erreur
- L'utilisateur doit configurer `NEXT_PUBLIC_SUPABASE_ANON_KEY` dans `.env.local` avec la cl√© de son projet Supabase

### Agent Model Used
Claude Opus 4.5 (via Cursor)

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-25 | 1.0 | Cr√©ation initiale de la story | SM Agent (Bob) |
| 2026-01-26 | 1.1 | Corrections PO: @supabase/ssr au lieu de auth-helpers (d√©pr√©ci√©), ajout Prerequisites, ajout react-hook-form, structure clients Supabase SSR, relation User Prisma, middleware s√©curis√© avec getUser(), tests d√©taill√©s, composant Label | PO Agent (Sarah) |
| 2026-01-26 | 1.2 | Impl√©mentation compl√®te de l'authentification praticien | DEV Agent (James) |
