# Story 1.2: Couche de Données (Prisma & Supabase)

## Status
Draft

## Story
**As a** développeur,
**I want** configurer Prisma avec Supabase PostgreSQL et créer le schéma de données,
**so that** l'application dispose d'une couche de persistance robuste et typée.

## Acceptance Criteria
1. Prisma est installé et initialisé dans le projet
2. La connexion à Supabase PostgreSQL est configurée via variables d'environnement
3. Le modèle User (praticien) est créé avec les champs appropriés
4. Le modèle Patient est créé avec les champs (id, nom, prénom, téléphone, email, createdAt, updatedAt)
5. Le modèle Appointment est créé avec la relation Patient (1) <-> (N) Appointment
6. La migration initiale est exécutée avec succès
7. Le client Prisma est généré et accessible dans le projet

## Tasks / Subtasks
- [ ] Task 1: Installation Prisma (AC: 1)
  - [ ] Exécuter `npm install prisma @prisma/client`
  - [ ] Exécuter `npx prisma init`
  - [ ] Créer le fichier `lib/prisma.ts` pour l'instance singleton du client
- [ ] Task 2: Configuration Supabase (AC: 2)
  - [ ] Créer le fichier `.env.local` avec `DATABASE_URL`
  - [ ] Créer `.env.example` avec les variables requises (sans valeurs sensibles)
  - [ ] Configurer `schema.prisma` avec le provider PostgreSQL
- [ ] Task 3: Modèle User (AC: 3)
  - [ ] Définir le modèle User dans `schema.prisma`:
    - id (String, uuid, @id, @default(uuid()))
    - email (String, @unique)
    - name (String)
    - createdAt (DateTime, @default(now()))
    - updatedAt (DateTime, @updatedAt)
- [ ] Task 4: Modèle Patient (AC: 4)
  - [ ] Définir le modèle Patient dans `schema.prisma`:
    - id (String, uuid, @id, @default(uuid()))
    - firstName (String)
    - lastName (String)
    - phone (String)
    - email (String, @unique)
    - createdAt (DateTime, @default(now()))
    - updatedAt (DateTime, @updatedAt)
    - appointments (Relation vers Appointment[])
- [ ] Task 5: Modèle Appointment (AC: 5)
  - [ ] Définir le modèle Appointment dans `schema.prisma`:
    - id (String, uuid, @id, @default(uuid()))
    - patientId (String, @relation)
    - patient (Relation vers Patient)
    - dateTime (DateTime)
    - duration (Int, en minutes)
    - status (Enum: PENDING, CONFIRMED, CANCELLED)
    - notes (String, optionnel)
    - createdAt (DateTime, @default(now()))
    - updatedAt (DateTime, @updatedAt)
- [ ] Task 6: Migration (AC: 6)
  - [ ] Exécuter `npx prisma migrate dev --name init`
  - [ ] Vérifier que les tables sont créées dans Supabase
- [ ] Task 7: Génération du client (AC: 7)
  - [ ] Exécuter `npx prisma generate`
  - [ ] Tester l'import du client dans un fichier

## Dev Notes

### Logique de Données
- **Relations**: Patient (1) <---> (N) Appointment
- **Accès**: Couche de services via Next.js Server Actions
[Source: docs/architecture/2-logique-de-donnes.md]

### Structure Single-Tenant
L'application est conçue pour un déploiement unique. Toutes les données en base appartiennent au même cabinet. Pas besoin de tenant_id dans les modèles.
[Source: docs/architecture/1-structure-globale.md]

### Configuration Prisma Singleton
```typescript
// lib/prisma.ts
import { PrismaClient } from '@prisma/client'

const globalForPrisma = globalThis as unknown as { prisma: PrismaClient }

export const prisma = globalForPrisma.prisma || new PrismaClient()

if (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = prisma
```

### Variables d'environnement requises
- `DATABASE_URL`: URL de connexion PostgreSQL Supabase

### Testing
- Vérifier la connexion à la base de données
- Tester les opérations CRUD basiques avec Prisma Studio (`npx prisma studio`)

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-25 | 1.0 | Création initiale de la story | SM Agent (Bob) |
