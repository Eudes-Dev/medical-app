# Story 1.2: Couche de Données (Prisma & Supabase)

## Status
Ready for Review ✅

## Prerequisites
- **Story 1.1**: Initialisation Next.js 16 (doit être complétée)
- **Compte Supabase**: Projet créé avec URL de connexion PostgreSQL

## Story
**As a** développeur,
**I want** configurer Prisma avec Supabase PostgreSQL et créer le schéma de données,
**so that** l'application dispose d'une couche de persistance robuste et typée.

## Acceptance Criteria
1. Prisma est installé et initialisé dans le projet
2. La connexion à Supabase PostgreSQL est configurée via variables d'environnement
3. Le modèle User (praticien) est créé avec les champs appropriés
4. Le modèle Patient est créé avec les champs requis (id, firstName, lastName, phone, email optionnel, dateOfBirth optionnel, notes optionnel, timestamps)
5. Le modèle Appointment est créé avec la relation Patient (1) <-> (N) Appointment
6. La migration initiale est exécutée avec succès
7. Le client Prisma est généré et accessible dans le projet
8. Les types TypeScript dans `types/index.ts` sont synchronisés avec le schéma Prisma

## Tasks / Subtasks
- [x] Task 1: Installation Prisma (AC: 1)
  - [x] Exécuter `npm install prisma @prisma/client`
  - [x] Exécuter `npx prisma init`
  - [x] Créer le fichier `lib/prisma.ts` pour l'instance singleton du client
- [x] Task 2: Configuration Supabase (AC: 2)
  - [x] Créer le fichier `.env.local` avec `DATABASE_URL` et `DIRECT_URL`
  - [x] Créer `.env.example` avec les variables requises (sans valeurs sensibles)
  - [x] Configurer `schema.prisma` avec le provider PostgreSQL et datasource
- [x] Task 3: Modèle User (AC: 3)
  - [x] Définir le modèle User dans `schema.prisma`:
    - id (String, uuid, @id, @default(uuid()))
    - email (String, @unique)
    - name (String)
    - createdAt (DateTime, @default(now()))
    - updatedAt (DateTime, @updatedAt)
  - Note: Ce modèle représente le profil praticien. L'authentification est gérée par Supabase Auth (Story 1.3)
- [x] Task 4: Modèle Patient (AC: 4)
  - [x] Définir le modèle Patient dans `schema.prisma`:
    - id (String, uuid, @id, @default(uuid()))
    - firstName (String)
    - lastName (String)
    - phone (String)
    - email (String?, optionnel) - optionnel car patients invités peuvent réserver sans compte
    - dateOfBirth (DateTime?, optionnel)
    - notes (String?, optionnel)
    - createdAt (DateTime, @default(now()))
    - updatedAt (DateTime, @updatedAt)
    - appointments (Relation vers Appointment[])
- [x] Task 5: Modèle Appointment (AC: 5)
  - [x] Définir l'enum AppointmentStatus dans `schema.prisma`:
    - PENDING (en attente de confirmation)
    - CONFIRMED (confirmé)
    - CANCELLED (annulé)
    - COMPLETED (terminé)
  - [x] Définir le modèle Appointment dans `schema.prisma`:
    - id (String, uuid, @id, @default(uuid()))
    - patientId (String, @relation)
    - patient (Relation vers Patient)
    - startTime (DateTime) - heure de début du rendez-vous
    - endTime (DateTime) - heure de fin du rendez-vous
    - status (AppointmentStatus, @default(PENDING))
    - type (String) - type de consultation
    - notes (String?, optionnel)
    - createdAt (DateTime, @default(now()))
    - updatedAt (DateTime, @updatedAt)
- [x] Task 6: Migration (AC: 6)
  - [x] Exécuter `npx prisma migrate dev --name init`
  - [x] Vérifier que les tables sont créées dans Supabase
- [x] Task 7: Génération du client (AC: 7)
  - [x] Exécuter `npx prisma generate`
  - [x] Tester l'import du client dans un fichier
- [x] Task 8: Synchronisation des types TypeScript (AC: 8)
  - [x] Mettre à jour `types/index.ts` pour aligner avec le schéma Prisma
  - [x] S'assurer que AppointmentStatus utilise les mêmes valeurs que l'enum Prisma
  - [x] Vérifier la cohérence des champs optionnels/obligatoires

## Dev Notes

### Logique de Données
- **Relations**: Patient (1) <---> (N) Appointment
- **Accès**: Couche de services via Next.js Server Actions
[Source: docs/architecture.md, docs/architecture/2-logique-de-donnes.md]

### Structure Single-Tenant
L'application est conçue pour un déploiement unique. Toutes les données en base appartiennent au même cabinet. Pas besoin de tenant_id dans les modèles.
[Source: docs/architecture.md, docs/architecture/1-structure-globale.md]

### Décisions d'Architecture
- **Email Patient optionnel**: Permet aux patients "invités" de réserver via le tunnel public sans email obligatoire
- **startTime/endTime vs duration**: Utilisation de startTime/endTime pour faciliter les requêtes de conflits horaires et l'affichage calendrier
- **Enum AppointmentStatus**: 4 statuts pour couvrir le cycle de vie complet (PENDING → CONFIRMED → COMPLETED ou CANCELLED)
- **Champ type dans Appointment**: Permet de catégoriser les types de consultation

### Configuration Prisma Singleton
```typescript
// lib/prisma.ts
import { PrismaClient } from '@prisma/client'

const globalForPrisma = globalThis as unknown as { prisma: PrismaClient }

export const prisma = globalForPrisma.prisma || new PrismaClient()

if (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = prisma
```

### Configuration Supabase (schema.prisma)
```prisma
datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}
```
Note: `directUrl` est requis pour les migrations avec Supabase (contourne le pooler pour les DDL).

### Variables d'environnement requises
- `DATABASE_URL`: URL de connexion PostgreSQL Supabase (avec pooler pour les requêtes)
- `DIRECT_URL`: URL de connexion directe (sans pooler, pour les migrations)

### Testing
- Vérifier la connexion à la base de données
- Tester les opérations CRUD basiques avec Prisma Studio (`npx prisma studio`)

## Dev Agent Record

### File List
| File | Status | Description |
|------|--------|-------------|
| `lib/prisma.ts` | Created | Instance singleton du client Prisma (évite les connexions multiples en dev) |
| `lib/generated/prisma/` | Generated | Client Prisma généré avec types pour User, Patient, Appointment |
| `prisma/schema.prisma` | Modified | Schéma Prisma avec modèles User, Patient, Appointment et enum AppointmentStatus |
| `prisma/migrations/20260126014944_init/` | Created | Migration initiale SQL créant les 3 tables et l'enum |
| `prisma.config.ts` | Modified | Configuration Prisma 7+ avec chargement .env.local |
| `.env.example` | Created | Template des variables d'environnement (sans valeurs sensibles) |
| `.env.local` | Modified | Variables d'environnement avec URLs Supabase configurées |
| `types/index.ts` | Modified | Types TypeScript synchronisés avec le schéma Prisma (User ajouté, AppointmentStatus en MAJUSCULES, helpers UI) |
| `package.json` | Modified | Ajout de prisma, @prisma/client et dotenv |

### Debug Log References
- Prisma 7+ nécessite la configuration des URLs dans `prisma.config.ts` (plus dans schema.prisma)
- dotenv installé pour charger `.env.local` dans la configuration Prisma

### Completion Notes
- Toutes les tâches (1-8) complètes ✅
- Migration `20260126014944_init` exécutée avec succès sur Supabase
- Tables créées: `users`, `patients`, `appointments` avec enum `AppointmentStatus`
- Index optimisés sur `patient_id` et `start_time` pour les requêtes calendrier
- Types TypeScript enrichis avec helpers UI (labels français, couleurs CSS)
- Relation CASCADE configurée : suppression d'un patient supprime ses rendez-vous

### Agent Model Used
Claude Opus 4.5

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-25 | 1.0 | Création initiale de la story | SM Agent (Bob) |
| 2026-01-26 | 1.1 | Corrections PO: alignement types/schéma Prisma, email optionnel, startTime/endTime, statut COMPLETED, champ type, prérequis, DIRECT_URL Supabase | PO Agent (Sarah) |
| 2026-01-26 | 1.2 | Implémentation complète: Prisma 7+ installé, schéma avec 3 modèles, migration exécutée sur Supabase, client généré, types synchronisés | Dev Agent (James) |
