# Story 2.1: Dashboard & Liste des Patients

## Status
Ready for Review üîç

## Story
**As a** praticien,
**I want** voir une liste interactive de tous mes patients avec recherche et pagination,
**so that** je puisse retrouver rapidement les informations d'un patient.

## Acceptance Criteria
1. Le dashboard `/dashboard` affiche les statistiques du jour (nombre de RDV, prochains RDV)
2. La page `/dashboard/patients` affiche une table interactive avec tous les patients
3. La table utilise les composants Shadcn Data Table
4. La recherche par nom/pr√©nom/email filtre les r√©sultats en temps r√©el
5. La pagination permet de naviguer entre les pages de r√©sultats (10 patients par page)
6. Chaque ligne permet d'acc√©der √† la fiche d√©taill√©e du patient
7. Un skeleton de chargement s'affiche pendant le fetch des donn√©es

## Tasks / Subtasks
- [x] Task 1: Layout Dashboard (AC: 1)
  - [x] Modifier `/app/dashboard/page.tsx` existant pour ajouter les statistiques
  - [x] Cr√©er un composant `DashboardStats` dans `/components/dashboard/dashboard-stats.tsx` affichant:
    - Nombre de RDV aujourd'hui (compte des appointments avec startTime dans la journ√©e)
    - Prochains RDV (liste des 5 prochains appointments avec status CONFIRMED ou PENDING, tri√©s par startTime)
  - [x] Cr√©er une Server Action `getDashboardStats()` dans `/app/dashboard/actions.ts` pour r√©cup√©rer les statistiques
  - [x] Utiliser Prisma pour interroger la table `appointments` avec filtres appropri√©s
- [x] Task 2: Structure de la page patients (AC: 2)
  - [x] Cr√©er `/app/dashboard/patients/page.tsx`
  - [x] Cr√©er le layout avec header "Gestion des Patients" utilisant les composants Shadcn (Card, CardHeader, CardTitle)
  - [x] Ajouter un bouton "Nouveau Patient" (pour story 2.2) avec Shadcn Button
- [x] Task 3: Composant Data Table (AC: 3)
  - [x] Installer les d√©pendances: `@tanstack/react-table`
  - [x] Ajouter les composants Shadcn n√©cessaires: `npx shadcn@latest add table`
  - [x] Cr√©er `/components/patients/patient-data-table.tsx`
  - [x] D√©finir les colonnes avec `@tanstack/react-table`: Nom (lastName), Pr√©nom (firstName), Email, T√©l√©phone (phone), Actions
- [x] Task 4: Server Action pour r√©cup√©rer les patients (AC: 2)
  - [x] Cr√©er `/app/dashboard/patients/actions.ts`
  - [x] Impl√©menter `getPatients(page: number, limit: number, search?: string)` avec Prisma
  - [x] Utiliser `prisma.patient.findMany()` avec pagination (skip/take) et filtrage conditionnel
  - [x] Utiliser `prisma.patient.count()` pour obtenir le total (avec les m√™mes filtres) pour la pagination
  - [x] Retourner un objet `{ patients, total }` pour permettre la pagination c√¥t√© client
- [x] Task 5: Recherche (AC: 4)
  - [x] Ajouter un champ de recherche avec Shadcn Input
  - [x] Impl√©menter le filtrage c√¥t√© serveur (nom, pr√©nom, email)
  - [x] Utiliser un debounce de 300ms pour √©viter les requ√™tes excessives
- [x] Task 6: Pagination (AC: 5)
  - [x] Impl√©menter la pagination avec `@tanstack/react-table`
  - [x] Afficher 10 patients par page
  - [x] Ajouter les contr√¥les de navigation (pr√©c√©dent, suivant, num√©ros de page)
- [x] Task 7: Navigation vers fiche patient (AC: 6)
  - [x] Ajouter un lien/bouton "Voir" sur chaque ligne
  - [x] Naviguer vers `/dashboard/patients/[id]`
- [x] Task 8: Skeleton de chargement (AC: 7)
  - [x] Cr√©er un composant `PatientTableSkeleton`
  - [x] Afficher le skeleton pendant le chargement initial
  - [x] Utiliser Suspense de React pour le loading state

## Dev Notes

### Architecture de l'Information
- `/dashboard`: Vue d'ensemble (statistiques du jour, prochains RDV)
- `/dashboard/patients`: Gestion de la base patient (recherche, fiches d√©taill√©es)
[Source: docs/front-end-spec/1-architecture-de-linformation-sitemap.md]

### Logique de Donn√©es
- **Relations**: Patient (1) <---> (N) Appointment
- **Acc√®s**: Couche de services via Next.js Server Actions
- **Sch√©ma Prisma**: Le mod√®le `Patient` contient les champs suivants:
  - `id`: UUID (g√©n√©r√© automatiquement)
  - `firstName`: String (mapp√© √† `first_name` en base)
  - `lastName`: String (mapp√© √† `last_name` en base)
  - `phone`: String (obligatoire)
  - `email`: String? (optionnel)
  - `dateOfBirth`: DateTime? (optionnel)
  - `notes`: String? (optionnel)
  - `createdAt`: DateTime
  - `updatedAt`: DateTime
  - `appointments`: Relation vers Appointment[]
- **Note**: Les champs Prisma utilisent camelCase (`firstName`, `lastName`) mais sont mapp√©s en snake_case en base (`first_name`, `last_name`)
- **Pour les statistiques du dashboard**: Utiliser le mod√®le `Appointment` avec:
  - `startTime`: DateTime (pour filtrer les RDV du jour)
  - `endTime`: DateTime
  - `status`: AppointmentStatus (PENDING, CONFIRMED, CANCELLED, COMPLETED)
  - `patientId`: UUID (relation vers Patient)
[Source: docs/architecture/2-logique-de-donnes.md, prisma/schema.prisma]

### Design System
- Utiliser les composants Shadcn UI (Table, Input, Button)
- Couleur principale: Blue-600 (#2563eb)
- Couleur neutre pour le texte: Slate-900 (#0f172a)
[Source: docs/front-end-spec/2-design-system-ui-components.md]

### Requ√™te Prisma exemple
```typescript
// Server Action getPatients dans /app/dashboard/patients/actions.ts
import { prisma } from '@/lib/prisma';

export async function getPatients(
  page: number = 1,
  limit: number = 10,
  search?: string
) {
  const where = search
    ? {
        OR: [
          { firstName: { contains: search, mode: 'insensitive' as const } },
          { lastName: { contains: search, mode: 'insensitive' as const } },
          { email: { contains: search, mode: 'insensitive' as const } },
        ],
      }
    : {};

  const [patients, total] = await Promise.all([
    prisma.patient.findMany({
      where,
      skip: (page - 1) * limit,
      take: limit,
      orderBy: { lastName: 'asc' },
    }),
    prisma.patient.count({ where }),
  ]);

  return { patients, total };
}
```

**Note importante**: 
- Le filtrage OR n'est appliqu√© que si `search` est fourni (non vide)
- Utiliser `mode: 'insensitive'` pour une recherche insensible √† la casse
- Le `total` est n√©cessaire pour calculer le nombre de pages dans la pagination
[Source: prisma/schema.prisma]

### Testing
- V√©rifier l'affichage correct de la table avec des donn√©es
- Tester la recherche avec diff√©rents crit√®res
- V√©rifier la pagination (navigation, nombre de r√©sultats)
- Tester l'affichage du skeleton pendant le chargement

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (via Cursor)

### Debug Log References
Aucun probl√®me bloquant rencontr√©.

### Completion Notes List
- Tous les Acceptance Criteria sont impl√©ment√©s
- Le dashboard affiche maintenant les statistiques r√©elles depuis la base de donn√©es (RDV aujourd'hui et prochains RDV)
- La page `/dashboard/patients` affiche une table interactive avec recherche et pagination
- La recherche utilise un debounce de 300ms pour √©viter les requ√™tes excessives
- La pagination fonctionne avec 10 patients par page
- Chaque ligne de la table contient un bouton "Voir" pour naviguer vers la fiche patient (route `/dashboard/patients/[id]` - √† impl√©menter dans story 2.2)
- Un skeleton de chargement s'affiche pendant le chargement des donn√©es
- Tous les composants sont bien comment√©s pour faciliter la compr√©hension du code
- Le linting et TypeScript passent sans erreur

### File List
| File | Action | Description |
|------|--------|-------------|
| `app/dashboard/actions.ts` | Created | Server Action getDashboardStats() pour r√©cup√©rer les statistiques du dashboard |
| `components/dashboard/dashboard-stats.tsx` | Created | Composants TodayAppointmentsCard et UpcomingAppointmentsCard pour afficher les statistiques |
| `app/dashboard/page.tsx` | Modified | Int√©gration des composants DashboardStats pour afficher les statistiques r√©elles |
| `app/dashboard/patients/page.tsx` | Created | Page de gestion des patients avec layout et bouton "Nouveau Patient" |
| `app/dashboard/patients/actions.ts` | Created | Server Action getPatients() avec pagination et recherche |
| `components/patients/patient-data-table.tsx` | Created | Composant Data Table avec @tanstack/react-table |
| `components/patients/patients-table-wrapper.tsx` | Created | Wrapper client pour g√©rer l'√©tat de recherche et pagination |
| `components/patients/patient-table-skeleton.tsx` | Created | Composant skeleton de chargement pour la table |
| `hooks/use-debounce.ts` | Created | Hook personnalis√© pour le debounce de la recherche |
| `components/ui/table.tsx` | Created | Composant Shadcn UI Table (via npx shadcn) |
| `package.json` | Modified | Ajout d√©pendance @tanstack/react-table |

## QA Results

### Review Date: 2026-01-29

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

L'impl√©mentation de la story 2.1 est fonctionnelle et bien structur√©e. Le code suit les bonnes pratiques Next.js avec une s√©paration claire entre Server Components, Client Components et Server Actions. La documentation est compl√®te avec des commentaires JSDoc d√©taill√©s. Les requ√™tes Prisma sont optimis√©es avec `Promise.all` pour les requ√™tes parall√®les et utilisent correctement la pagination et les filtres.

**Points forts:**
- Architecture claire avec s√©paration Server/Client Components
- Code bien document√© avec JSDoc
- Requ√™tes Prisma optimis√©es (Promise.all, pagination efficace)
- Utilisation appropri√©e du debounce pour la recherche (300ms)
- Gestion correcte des √©tats de chargement avec skeleton
- Int√©gration propre avec Shadcn UI

**Points √† am√©liorer:**
- Absence totale de tests automatis√©s (critique)
- Gestion d'erreurs d'authentification pourrait √™tre plus explicite
- Validation des entr√©es utilisateur c√¥t√© serveur √† renforcer
- Gestion d'erreurs Prisma non explicite

### Refactoring Performed

Aucun refactoring n'a √©t√© effectu√© lors de cette revue. Le code est d√©j√† bien structur√© et suit les patterns appropri√©s. Les am√©liorations sugg√©r√©es sont document√©es dans les recommandations ci-dessous.

### Compliance Check

- Coding Standards: ‚úì Code suit les conventions TypeScript/Next.js, bien format√©
- Project Structure: ‚úì Fichiers organis√©s selon la structure du projet
- Testing Strategy: ‚úó Aucun test n'a √©t√© impl√©ment√© (voir test design pour recommandations)
- All ACs Met: ‚úì Tous les crit√®res d'acceptation sont impl√©ment√©s fonctionnellement

### Improvements Checklist

- [ ] Ajouter des tests automatis√©s selon le test design (docs/qa/assessments/2.1-test-design-20260129.md)
- [ ] Am√©liorer la gestion d'erreurs d'authentification dans les Server Actions (lever une erreur explicite au lieu de retourner null/[])
- [ ] Ajouter validation Zod pour le param√®tre search dans getPatients
- [ ] Ajouter gestion d'erreurs explicite avec try-catch dans les Server Actions
- [ ] Consid√©rer l'ajout d'un syst√®me de cache pour les requ√™tes fr√©quentes (future optimisation)

### Security Review

**Statut: CONCERNS**

L'authentification est v√©rifi√©e dans les Server Actions via Supabase Auth, et le middleware prot√®ge les routes `/dashboard/*`. Cependant:

1. **Gestion d'erreurs non authentifi√©**: Les Server Actions retournent `null` ou `[]` au lieu de lever une erreur explicite. Cela peut masquer des probl√®mes de s√©curit√© et rendre le debugging plus difficile.

2. **Validation des entr√©es**: Le param√®tre `search` n'est pas valid√©/sanitis√© c√¥t√© serveur. Bien que Prisma utilise des requ√™tes param√©tr√©es (protection contre SQL injection), une validation de longueur et de caract√®res autoris√©s serait recommand√©e.

3. **Protection contre les attaques**: Pas de rate limiting visible sur les endpoints de recherche (√† consid√©rer pour la production).

**Recommandations:**
- Lever une `UnauthorizedError` explicite dans les Server Actions si l'utilisateur n'est pas authentifi√©
- Ajouter une validation Zod pour le param√®tre search (longueur max, caract√®res autoris√©s)
- Consid√©rer l'ajout de rate limiting pour les endpoints de recherche (story future)

### Performance Considerations

**Statut: PASS**

Les performances sont bien g√©r√©es:

1. **Requ√™tes Prisma optimis√©es**: Utilisation de `Promise.all` pour ex√©cuter les requ√™tes en parall√®le (patients + count)
2. **Pagination efficace**: Utilisation correcte de `skip`/`take` pour limiter les r√©sultats
3. **Debounce de recherche**: 300ms de d√©lai pour √©viter les requ√™tes excessives
4. **Index Prisma**: Le sch√©ma Prisma d√©finit des index sur `patientId` et `startTime` pour optimiser les requ√™tes

**Recommandations futures:**
- Consid√©rer l'ajout d'un cache Redis pour les requ√™tes fr√©quentes (dashboard stats)
- Surveiller les performances avec un grand nombre de patients (>10,000)
- Ajouter des m√©triques de performance pour surveiller les requ√™tes Prisma

### Files Modified During Review

Aucun fichier n'a √©t√© modifi√© lors de cette revue. Les recommandations sont document√©es ci-dessus et dans le fichier gate.

### Gate Status

Gate: **CONCERNS** ‚Üí `docs/qa/gates/2.1-dashboard-liste-patients.yml`
Test design: `docs/qa/assessments/2.1-test-design-20260129.md`

**D√©cision du gate:** CONCERNS - L'impl√©mentation est fonctionnelle et bien structur√©e, mais l'absence de tests automatis√©s et quelques pr√©occupations de s√©curit√© doivent √™tre adress√©es avant la mise en production.

**Score de qualit√©:** 70/100
- Points d√©duits: -20 (absence de tests), -10 (pr√©occupations s√©curit√©)

### Recommended Status

‚úó **Changes Required** - Voir les √©l√©ments non coch√©s dans la checklist ci-dessus

**Actions requises avant "Ready for Done":**
1. Ajouter des tests automatis√©s (au minimum les tests P0 du test design)
2. Am√©liorer la gestion d'erreurs d'authentification
3. Ajouter validation des entr√©es utilisateur

**Note:** Le code fonctionne correctement et tous les ACs sont impl√©ment√©s. Les pr√©occupations sont principalement li√©es √† la qualit√©, la s√©curit√© et la maintenabilit√© √† long terme.

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-25 | 1.0 | Cr√©ation initiale de la story | SM Agent (Bob) |
| 2026-01-29 | 1.1 | Validation PO: Correction des chemins de fichiers, ajout sections manquantes (Dev Agent Record, QA Results), am√©lioration Dev Notes avec r√©f√©rence sch√©ma Prisma, am√©lioration section Testing, correction requ√™te Prisma avec gestion search vide | PO Agent (Sarah) |
| 2026-01-29 | 1.2 | Impl√©mentation compl√®te du dashboard et de la liste des patients avec recherche et pagination | DEV Agent (James) |
