# Story 3.1: State Management (Zustand)

## Status
Draft

## Story
**As a** développeur,
**I want** implémenter un store Zustand pour gérer l'état de l'agenda,
**so that** l'interface calendrier soit réactive et permette des transitions fluides.

## Acceptance Criteria
1. Zustand est installé et configuré dans le projet
2. Le store `useCalendarStore` gère la date pivot (date actuellement affichée)
3. Le store gère les filtres de vue (jour, semaine, masquer annulés)
4. Le store maintient un cache local des rendez-vous chargés
5. Les actions permettent de naviguer entre les dates (suivant, précédent, aujourd'hui)
6. Le store est typé avec TypeScript
7. La persistance locale optionnelle sauvegarde les préférences de vue

## Tasks / Subtasks
- [ ] Task 1: Installation Zustand (AC: 1)
  - [ ] Exécuter `npm install zustand`
  - [ ] Créer le dossier `/stores/`
- [ ] Task 2: Création du store CalendarStore (AC: 2, 3, 6)
  - [ ] Créer `/stores/useCalendarStore.ts`
  - [ ] Définir les types TypeScript:
    ```typescript
    type ViewMode = 'day' | 'week' | 'month'
    type CalendarState = {
      pivotDate: Date
      viewMode: ViewMode
      showCancelled: boolean
      appointmentsCache: Map<string, Appointment[]>
    }
    ```
  - [ ] Implémenter le store avec les propriétés initiales
- [ ] Task 3: Actions de navigation (AC: 5)
  - [ ] Implémenter `goToNext()` - avancer selon viewMode
  - [ ] Implémenter `goToPrevious()` - reculer selon viewMode
  - [ ] Implémenter `goToToday()` - revenir à aujourd'hui
  - [ ] Implémenter `setDate(date: Date)` - aller à une date spécifique
- [ ] Task 4: Actions de filtrage (AC: 3)
  - [ ] Implémenter `setViewMode(mode: ViewMode)`
  - [ ] Implémenter `toggleShowCancelled()`
- [ ] Task 5: Gestion du cache (AC: 4)
  - [ ] Implémenter `setAppointments(date: string, appointments: Appointment[])`
  - [ ] Implémenter `getAppointments(date: string)` - retourne depuis le cache ou null
  - [ ] Implémenter `clearCache()` - vide le cache (après modification)
  - [ ] Clé de cache format: 'YYYY-MM-DD' pour jour, 'YYYY-WW' pour semaine
- [ ] Task 6: Persistance locale (AC: 7)
  - [ ] Utiliser `zustand/middleware` avec `persist`
  - [ ] Persister uniquement: viewMode, showCancelled
  - [ ] Ne PAS persister: pivotDate, appointmentsCache

## Dev Notes

### Gestion d'État (Zustand)
Le store `useCalendarStore` gère:
- La date pivot de l'affichage
- Les filtres de vue (ex: masquer les RDV annulés)
- Le cache local pour permettre des transitions instantanées entre les jours

La synchronisation avec le serveur est simplifiée par l'absence de scope "Tenant" (architecture Single-Tenant).
[Source: docs/architecture/3-gestion-dtat-zustand.md]
[Source: docs/front-end-spec.md - Section 3]

### Structure recommandée du store
```typescript
import { create } from 'zustand'
import { persist } from 'zustand/middleware'

interface CalendarState {
  // State
  pivotDate: Date
  viewMode: 'day' | 'week' | 'month'
  showCancelled: boolean
  appointmentsCache: Record<string, Appointment[]>
  
  // Actions
  goToNext: () => void
  goToPrevious: () => void
  goToToday: () => void
  setDate: (date: Date) => void
  setViewMode: (mode: 'day' | 'week' | 'month') => void
  toggleShowCancelled: () => void
  setAppointments: (key: string, appointments: Appointment[]) => void
  clearCache: () => void
}

export const useCalendarStore = create<CalendarState>()(
  persist(
    (set, get) => ({
      // ... implementation
    }),
    {
      name: 'calendar-preferences',
      partialize: (state) => ({ 
        viewMode: state.viewMode, 
        showCancelled: state.showCancelled 
      }),
    }
  )
)
```

### Utilitaires de date recommandés
- Utiliser `date-fns` pour les manipulations de dates
- `addDays`, `addWeeks`, `addMonths` pour la navigation
- `format` pour les clés de cache
- `startOfWeek`, `endOfWeek` pour le calcul des plages

### Testing
- Vérifier que la navigation change correctement la date pivot
- Tester les transitions jour/semaine/mois
- Vérifier la persistance des préférences après rechargement
- Tester le cache: ajout, récupération, invalidation

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-25 | 1.0 | Création initiale de la story | SM Agent (Bob) |
