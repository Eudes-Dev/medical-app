# Story 3.1: State Management (Zustand)

## Status
Approved

## Story
**As a** développeur,
**I want** implémenter un store Zustand pour gérer l'état de l'agenda,
**so that** l'interface calendrier soit réactive et permette des transitions fluides.

## Acceptance Criteria
1. Zustand est installé et configuré dans le projet
2. Le store `useCalendarStore` gère la date pivot (date actuellement affichée)
3. Le store gère les filtres de vue (jour, semaine, masquer annulés)
4. Le store maintient un cache local des rendez-vous chargés
5. Les actions permettent de naviguer entre les dates (suivant, précédent, aujourd'hui)
6. Le store est typé avec TypeScript
7. La persistance locale optionnelle sauvegarde les préférences de vue

## Tasks / Subtasks
- [x] Task 1: Installation Zustand (AC: 1)
  - [x] Exécuter `npm install zustand`
  - [x] Créer le dossier `/stores/`
- [x] Task 2: Création du store CalendarStore (AC: 2, 3, 6)
  - [x] Créer `/stores/useCalendarStore.ts`
  - [x] Définir les types TypeScript:
    ```typescript
    type ViewMode = 'day' | 'week' | 'month'
    type CalendarState = {
      pivotDate: Date
      viewMode: ViewMode
      showCancelled: boolean
      appointmentsCache: Record<string, Appointment[]>
    }
    ```
  - [x] Implémenter le store avec les propriétés initiales
- [x] Task 3: Actions de navigation (AC: 5)
  - [x] Implémenter `goToNext()` - avancer selon viewMode
  - [x] Implémenter `goToPrevious()` - reculer selon viewMode
  - [x] Implémenter `goToToday()` - revenir à aujourd'hui
  - [x] Implémenter `setDate(date: Date)` - aller à une date spécifique
- [x] Task 4: Actions de filtrage (AC: 3)
  - [x] Implémenter `setViewMode(mode: ViewMode)`
  - [x] Implémenter `toggleShowCancelled()`
- [x] Task 5: Gestion du cache (AC: 4)
  - [x] Implémenter `setAppointments(date: string, appointments: Appointment[])`
  - [x] Implémenter `getAppointments(date: string)` - retourne depuis le cache ou null
  - [x] Implémenter `clearCache()` - vide le cache (après modification)
  - [x] Clé de cache format: 'YYYY-MM-DD' pour jour, 'YYYY-WW' pour semaine, 'YYYY-MM' pour mois
- [x] Task 6: Persistance locale (AC: 7)
  - [x] Utiliser `zustand/middleware` avec `persist`
  - [x] Persister uniquement: viewMode, showCancelled
  - [x] Ne PAS persister: pivotDate, appointmentsCache

## Dev Notes

### Gestion d'État (Zustand)
Le store `useCalendarStore` gère:
- La date pivot de l'affichage
- Les filtres de vue (ex: masquer les RDV annulés)
- Le cache local pour permettre des transitions instantanées entre les jours

La synchronisation avec le serveur est simplifiée par l'absence de scope "Tenant" (architecture Single-Tenant).
[Source: docs/architecture/3-gestion-dtat-zustand.md]
[Source: docs/front-end-spec.md - Section 3]

### Structure recommandée du store
```typescript
import { create } from 'zustand'
import { persist } from 'zustand/middleware'

interface CalendarState {
  // State
  pivotDate: Date
  viewMode: 'day' | 'week' | 'month'
  showCancelled: boolean
  appointmentsCache: Record<string, Appointment[]>
  
  // Actions
  goToNext: () => void
  goToPrevious: () => void
  goToToday: () => void
  setDate: (date: Date) => void
  setViewMode: (mode: 'day' | 'week' | 'month') => void
  toggleShowCancelled: () => void
  setAppointments: (key: string, appointments: Appointment[]) => void
  getAppointments: (date: string) => Appointment[] | null
  clearCache: () => void
}

export const useCalendarStore = create<CalendarState>()(
  persist(
    (set, get) => ({
      // ... implementation
    }),
    {
      name: 'calendar-preferences',
      partialize: (state) => ({ 
        viewMode: state.viewMode, 
        showCancelled: state.showCancelled 
      }),
    }
  )
)
```

### Utilitaires de date recommandés
- Utiliser `date-fns` pour les manipulations de dates
- `addDays`, `addWeeks`, `addMonths` pour la navigation
- `format` pour les clés de cache
- `startOfWeek`, `endOfWeek` pour le calcul des plages

### Testing
- Vérifier que la navigation change correctement la date pivot
- Tester les transitions jour/semaine/mois
- Vérifier la persistance des préférences après rechargement
- Tester le cache: ajout, récupération, invalidation

## Dev Agent Record

### File List
- `stores/useCalendarStore.ts` (créé) — Store Zustand typé, actions navigation/filtres/cache, persist viewMode/showCancelled
- `tests/unit/stores/useCalendarStore.test.ts` (créé) — Tests unitaires navigation, filtres, cache, getCacheKeyForView
- `package.json` (modifié) — Dépendances zustand, date-fns

### Completion Notes
- Store créé avec commentaires détaillés pour faciliter la compréhension.
- Helper `getCacheKeyForView(pivotDate, viewMode)` exporté pour usage par la vue calendrier (Story 3.2).
- Clé semaine au format `YYYY-Www` (w = numéro de semaine ISO, 2 chiffres).

## QA Results

- **Gate :** PASS (2026-01-29)
- **Test design :** [docs/qa/assessments/3.1-test-design-20260129.md](../qa/assessments/3.1-test-design-20260129.md) — 16 scénarios (15 unit, 1 e2e), P0: 10, P1: 5, P2: 1
- **Gate file :** [docs/qa/gates/3.1-state-management-zustand.yml](../qa/gates/3.1-state-management-zustand.yml)
- **Tests exécutés :** 14 tests unitaires (useCalendarStore) — tous passent
- **Couverture AC :** AC1–AC7 couverts par le test design ; les tests existants couvrent navigation, filtres, cache et getCacheKeyForView. E2E persistance (3.1-E2E-001) recommandé en option avec Story 3.2.

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-25 | 1.0 | Création initiale de la story | SM Agent (Bob) |
| 2026-01-29 | 1.2 | Implémentation store useCalendarStore, tests unitaires, dépendances zustand + date-fns | Dev (James) |
| 2026-01-29 | 1.1 | Revue PO : cohérence Map→Record, getAppointments dans l’interface, clés cache mois ; statut → Approved | PO (Sarah) |
