# Story 3.3: Gestion des Créneaux

## Status
Approved

## Story
**As a** praticien,
**I want** créer et gérer des rendez-vous rapidement depuis l'agenda,
**so that** je puisse organiser efficacement mes consultations.

## Acceptance Criteria
1. Un clic sur un créneau vide ouvre une modal de création de RDV
2. La modal permet de sélectionner un patient existant ou d'en créer un nouveau
3. Le formulaire contient: patient, date/heure de début, durée, type de consultation, notes optionnelles
4. Le système vérifie les conflits d'horaires avant validation
5. Un message d'erreur s'affiche si le créneau est déjà occupé
6. La création réussie affiche un toast et met à jour l'agenda instantanément
7. Un clic sur un RDV existant ouvre ses détails avec options de modification
8. Le praticien peut modifier le statut (confirmer, annuler, terminer) ou supprimer le RDV

## Tasks / Subtasks
- [x] Task 1: Modal de création de RDV (AC: 1, 3)
  - [x] Créer `components/calendar/CreateAppointmentModal.tsx`
  - [x] Utiliser Shadcn Dialog
  - [x] Pré-remplir la date/heure de début selon le créneau cliqué
  - [x] Champs: patient (select), type (select: ex. Première consultation, Suivi, Urgence), durée (select: 15, 30, 45, 60 min), notes (textarea)
- [x] Task 2: Sélection de patient (AC: 2)
  - [ ] Créer un composant `PatientSelect` avec recherche
  - [ ] Utiliser Shadcn Combobox
  - [ ] Permettre la recherche par nom/email
  - [ ] Ajouter un bouton "Nouveau patient" qui ouvre le modal de création de patient existant (`CreatePatientModal` / `components/patients/create-patient-modal.tsx`), puis rafraîchir la liste et pré-sélectionner le patient créé
- [x] Task 3: Schéma de validation Zod (AC: 3)
  - [ ] Créer `lib/validations/appointment.ts`
  - [ ] Définir `appointmentSchema` (côté formulaire: startTime + duration; la server action convertit en startTime/endTime pour Prisma):
    - patientId: string, requis
    - startTime: date, requis, dans le futur
    - duration: number, enum (15, 30, 45, 60)
    - type: string, requis (ex. Première consultation, Suivi, Urgence)
    - notes: string, optionnel, max 500 caractères
- [x] Task 4: Server Action - Vérification conflits (AC: 4, 5)
  - [x] Étendre `app/dashboard/calendar/actions.ts` (fichier existant, Story 3.2)
  - [x] Implémenter `checkConflict(startTime, endTime, excludeId?)` (ou `checkConflict(startTime, durationMinutes, excludeId?)` en calculant endTime en interne)
  - [x] Vérifier les chevauchements avec les RDV existants (condition d’intersection: existant.startTime < newEnd && existant.endTime > newStart; exclure statut CANCELLED)
  - [x] Retourner `{ hasConflict: boolean, conflictingAppointment?: AppointmentWithPatient }` (inclure patient pour afficher un message d’erreur explicite)
- [x] Task 5: Server Action - CRUD Rendez-vous (AC: 6)
  - [x] Implémenter `createAppointment(data)` dans `app/dashboard/calendar/actions.ts`
    - Valider avec Zod (startTime + duration → calculer endTime pour Prisma)
    - Vérifier les conflits via checkConflict
    - Insérer avec Prisma (startTime, endTime, type, patientId, notes, status: PENDING)
    - Invalider le cache Zustand
  - [x] Implémenter `updateAppointment(id, data)` (mise à jour partielle, revérifier conflits si startTime/endTime modifiés)
  - [x] Implémenter `deleteAppointment(id)`
- [x] Task 6: Feedback utilisateur (AC: 6)
  - [x] Afficher toast succès après création/modification
  - [x] Mettre à jour l'agenda via `revalidatePath` + clear cache Zustand
  - [x] Fermer la modal automatiquement après succès
- [x] Task 7: Modal détails RDV (AC: 7)
  - [x] Créer `components/calendar/AppointmentDetailsModal.tsx` (Dialog desktop ; sur mobile utiliser Sheet/Drawer Vaul comme en 3.2 pour cohérence)
  - [x] Afficher: patient (lien vers `/dashboard/patients/[id]`), date/heure de début, durée (dérivée de startTime/endTime), type, statut, notes
  - [x] Boutons: Modifier, Changer statut, Supprimer
- [x] Task 8: Gestion des statuts (AC: 8)
  - [x] Implémenter `updateAppointmentStatus(id, status)` dans `app/dashboard/calendar/actions.ts`
  - [x] Bouton "Confirmer" → CONFIRMED
  - [x] Bouton "Annuler" → CANCELLED (demander confirmation)
  - [x] Bouton "Terminer" → COMPLETED (optionnel, selon périmètre)
  - [x] Bouton "Supprimer" → suppression définitive (demander confirmation)

## Dev Notes

### Logique de Données
- **Relations**: Patient (1) <---> (N) Appointment
- **Accès**: Couche de services via Next.js Server Actions (app/dashboard/calendar/actions.ts)
[Source: docs/architecture/2-logique-de-donnes.md]

### PRD - Critères d'Acceptation
- Le praticien peut déplacer un RDV par simple clic (via l'état Zustand)
- Les données sont persistées en base PostgreSQL via Prisma
[Source: docs/prd/4-critères-dacceptation.md]

### User Stories PRD
- US.1: En tant que praticien, je veux gérer mes disponibilités pour que les patients ne réservent que sur mes heures de travail.
- US.3: En tant que praticien, je veux voir ma liste de patients et l'historique de leurs rendez-vous.
La story 3.3 réalise la création et la gestion des RDV depuis l'agenda (complémentaire à US.1/US.3).
[Source: docs/prd/3-user-stories-prioritaires.md]

### Design System
- **Modals**: Pour les formulaires de création sans quitter le contexte actuel
- **Formulaires**: Utiliser le composant `InputGroup` pour tous les champs (label, input, message d’erreur) — convention projet (.cursor/rules/forms-input-group.mdc)
- Couleur principale bouton: Blue-600 (#2563eb)
- Couleur Erreur (annuler/supprimer): Rose-500
[Source: docs/front-end-spec/2-design-system-ui-components.md]

### Schéma Prisma Appointment
Le modèle utilise **startTime** et **endTime** (pas dateTime/duration). Le champ **type** est requis.
```prisma
model Appointment {
  id        String            @id @default(uuid())
  patientId String            @map("patient_id")
  patient   Patient           @relation(...)
  startTime DateTime          @map("start_time")
  endTime   DateTime          @map("end_time")
  status    AppointmentStatus @default(PENDING)
  type      String            // ex. "Première consultation", "Suivi", "Urgence"
  notes     String?
  createdAt DateTime          @default(now()) @map("created_at")
  updatedAt DateTime          @updatedAt @map("updated_at")
}

enum AppointmentStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
}
```
[Source: prisma/schema.prisma]

### Algorithme de détection de conflit
Utiliser **startTime** et **endTime** du modèle. Intersection: deux plages se chevauchent si `existant.startTime < newEnd && existant.endTime > newStart`. Exclure les RDV au statut CANCELLED.
```typescript
async function checkConflict(
  startTime: Date,
  endTime: Date,
  excludeId?: string
): Promise<{ hasConflict: boolean; conflictingAppointment?: AppointmentWithPatient }> {
  const conflict = await prisma.appointment.findFirst({
    where: {
      ...(excludeId ? { id: { not: excludeId } } : {}),
      status: { not: "CANCELLED" },
      startTime: { lt: endTime },
      endTime: { gt: startTime },
    },
    include: { patient: true },
  });
  return { hasConflict: !!conflict, conflictingAppointment: conflict ?? undefined };
}
```
Si l’API reçoit (startTime, durationMinutes), calculer `endTime = addMinutes(startTime, durationMinutes)` avant d’appeler checkConflict.

### Testing
- Tester la création de RDV sur un créneau vide (avec type, patient, durée)
- Vérifier la détection de conflit avec RDV existant (startTime/endTime)
- Tester la modification de statut (CONFIRMED, CANCELLED, COMPLETED)
- Vérifier la mise à jour instantanée de l'agenda (revalidatePath + cache Zustand)
- Tester la suppression avec confirmation

## Dev Agent Record
*(À remplir par l’agent de développement pendant l’implémentation.)*

### Agent Model Used
*Auto (Cursor)*

### Debug Log References
*Aucune.*

### Completion Notes List
- PatientSelect: comportement type Combobox (input + liste avec recherche par nom/email, bouton "Nouveau patient") sans dépendance Shadcn Command/Popover; CreatePatientModal étendu en mode contrôlé (open/onOpenChange/onPatientCreated) pour ouverture depuis PatientSelect.
- CreateAppointmentModal supporte aussi le mode édition (prop `appointment`) pour le bouton "Modifier" du détail RDV.
- Grille: créneaux cliquables (z-0) derrière le contenu (z-10) pour que le clic sur un créneau vide ouvre la création de RDV.

### File List
- **Créés:** `lib/validations/appointment.ts`, `components/calendar/PatientSelect.tsx`, `components/calendar/CreateAppointmentModal.tsx`, `components/calendar/AppointmentDetailsModal.tsx`
- **Modifiés:** `app/dashboard/calendar/actions.ts`, `components/calendar/CalendarGrid.tsx`, `app/dashboard/calendar/page.tsx`, `components/patients/create-patient-modal.tsx`

## QA Results

### Review Date: 2026-01-30

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

L’implémentation de la story 3.3 (Gestion des Créneaux) est **solide et alignée avec les critères d’acceptation**. Les Server Actions (checkConflict, createAppointment, updateAppointment, deleteAppointment, updateAppointmentStatus) sont bien structurées, documentées et gèrent correctement l’auth, la validation Zod, les conflits et le revalidatePath. Les modals CreateAppointmentModal et AppointmentDetailsModal (Dialog desktop / Sheet mobile) respectent le périmètre. PatientSelect offre la recherche et l’option « Nouveau patient » avec intégration à CreatePatientModal. La grille expose un clic sur créneau vide (z-0) pour ouvrir la création de RDV. **Point d’attention :** aucun test automatisé dédié à la story 3.3 n’est encore en place (checkConflict, CRUD, statuts) ; un test-design a été rédigé pour combler cette lacune.

### Refactoring Performed

Aucun refactoring effectué lors de cette revue. Les éventuelles évolutions (convention InputGroup pour les champs select/textarea du formulaire RDV) sont documentées dans les recommandations.

### Compliance Check

- **Coding Standards:** ✓ (pas de fichier docs/coding-standards.md ; code cohérent avec le reste du projet)
- **Project Structure:** ✓ (fichiers dans components/calendar, app/dashboard/calendar, lib/validations)
- **Testing Strategy:** ✗ Aucun test automatisé spécifique à la story 3.3 (checkConflict, create/update/delete/status) ; test-design rédigé dans docs/qa/assessments/3.3-test-design-20260130.md
- **All ACs Met:** ✓ Les 8 critères d’acceptation sont implémentés (modal création, PatientSelect + nouveau patient, formulaire complet, vérification conflits, message d’erreur conflit, toast + mise à jour agenda, modal détails avec lien patient, modification statut et suppression avec confirmations)

### Improvements Checklist

- [x] Rédaction du test-design 3.3 (scénarios Given-When-Then, traceabilité AC → tests) dans docs/qa/assessments/3.3-test-design-20260130.md
- [ ] Implémenter les tests d’intégration pour checkConflict, createAppointment, updateAppointment, deleteAppointment, updateAppointmentStatus (voir 3.3-INT-001 à 3.3-INT-012)
- [ ] Implémenter les tests unitaires pour appointmentSchema (3.3-UNIT-001 à 3.3-UNIT-003)
- [ ] À terme : scénarios E2E 3.3-E2E-001 à 3.3-E2E-006 lorsque le runner E2E calendrier est en place
- [ ] Optionnel : aligner les champs du formulaire CreateAppointmentModal sur la convention InputGroup (label + champ + erreur) pour select/textarea si le design system étend InputGroup à ces types

### Security Review

- ensureAuth() est appelé dans toutes les Server Actions ; UnauthorizedError est propagée. Aucune faille identifiée.

### Performance Considerations

- PatientSelect utilise un debounce (300 ms) pour la recherche. getPatients(1, 50, search) limite le nombre de résultats. Aucun point bloquant identifié.

### Files Modified During Review

Aucun fichier modifié pendant la revue (uniquement ajout de docs/qa/assessments/3.3-test-design-20260130.md et docs/qa/gates/3.3-gestion-creneaux.yml).

### Gate Status

Gate: **CONCERNS** → docs/qa/gates/3.3-gestion-creneaux.yml  
Test design: docs/qa/assessments/3.3-test-design-20260130.md

### Recommended Status

**✓ Ready for Done** sous réserve que l’équipe accepte la lacune de tests automatisés pour la 3.3 et planifie leur implémentation (recommandation : prioriser les tests d’intégration checkConflict et createAppointment). Le propriétaire de la story décide du statut final.

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-30 | 1.2 | Dernières corrections (PatientSelect→CreatePatientModal, InputGroup, type retour checkConflict, lien fiche patient, responsive Task 7) ; passage en Approved | PO (Sarah) |
| 2026-01-30 | 1.1 | Alignement schéma Prisma (startTime/endTime, type), chemins, références PRD, algorithme conflit, sections Dev Agent Record et QA Results | PO (Sarah) |
| 2026-01-25 | 1.0 | Création initiale de la story | SM Agent (Bob) |
