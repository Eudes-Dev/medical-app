# Story 3.3: Gestion des Créneaux

## Status
Draft

## Story
**As a** praticien,
**I want** créer et gérer des rendez-vous rapidement depuis l'agenda,
**so that** je puisse organiser efficacement mes consultations.

## Acceptance Criteria
1. Un clic sur un créneau vide ouvre une modal de création de RDV
2. La modal permet de sélectionner un patient existant ou d'en créer un nouveau
3. Le formulaire contient: patient, date/heure, durée, notes optionnelles
4. Le système vérifie les conflits d'horaires avant validation
5. Un message d'erreur s'affiche si le créneau est déjà occupé
6. La création réussie affiche un toast et met à jour l'agenda instantanément
7. Un clic sur un RDV existant ouvre ses détails avec options de modification
8. Le praticien peut modifier le statut (confirmer, annuler) ou supprimer le RDV

## Tasks / Subtasks
- [ ] Task 1: Modal de création de RDV (AC: 1, 3)
  - [ ] Créer `/components/calendar/CreateAppointmentModal.tsx`
  - [ ] Utiliser Shadcn Dialog
  - [ ] Pré-remplir la date/heure selon le créneau cliqué
  - [ ] Champs: patient (select), durée (select: 15, 30, 45, 60 min), notes (textarea)
- [ ] Task 2: Sélection de patient (AC: 2)
  - [ ] Créer un composant `PatientSelect` avec recherche
  - [ ] Utiliser Shadcn Combobox
  - [ ] Permettre la recherche par nom/email
  - [ ] Ajouter un bouton "Nouveau patient" qui ouvre le formulaire de création
- [ ] Task 3: Schéma de validation Zod (AC: 3)
  - [ ] Créer `/lib/validations/appointment.ts`
  - [ ] Définir `appointmentSchema`:
    - patientId: string, requis
    - dateTime: date, requis, dans le futur
    - duration: number, enum (15, 30, 45, 60)
    - notes: string, optionnel, max 500 caractères
- [ ] Task 4: Server Action - Vérification conflits (AC: 4, 5)
  - [ ] Créer `/app/(dashboard)/dashboard/calendar/actions.ts`
  - [ ] Implémenter `checkConflict(dateTime, duration, excludeId?)`
  - [ ] Vérifier les chevauchements avec les RDV existants
  - [ ] Retourner `{ hasConflict: boolean, conflictingAppointment?: Appointment }`
- [ ] Task 5: Server Action - CRUD Rendez-vous (AC: 6)
  - [ ] Implémenter `createAppointment(data)`
    - Valider avec Zod
    - Vérifier les conflits
    - Insérer avec Prisma
    - Invalider le cache Zustand
  - [ ] Implémenter `updateAppointment(id, data)`
  - [ ] Implémenter `deleteAppointment(id)`
- [ ] Task 6: Feedback utilisateur (AC: 6)
  - [ ] Afficher toast succès après création/modification
  - [ ] Mettre à jour l'agenda via `revalidatePath` + clear cache Zustand
  - [ ] Fermer la modal automatiquement après succès
- [ ] Task 7: Modal détails RDV (AC: 7)
  - [ ] Créer `/components/calendar/AppointmentDetailsModal.tsx`
  - [ ] Afficher: patient (lien vers fiche), date/heure, durée, statut, notes
  - [ ] Boutons: Modifier, Changer statut, Supprimer
- [ ] Task 8: Gestion des statuts (AC: 8)
  - [ ] Implémenter `updateAppointmentStatus(id, status)`
  - [ ] Bouton "Confirmer" → CONFIRMED
  - [ ] Bouton "Annuler" → CANCELLED (demander confirmation)
  - [ ] Bouton "Supprimer" → suppression définitive (demander confirmation)

## Dev Notes

### Logique de Données
- **Relations**: Patient (1) <---> (N) Appointment
- **Accès**: Couche de services via Next.js Server Actions
[Source: docs/architecture/2-logique-de-donnes.md]

### PRD - Critères d'Acceptation
- Le praticien peut déplacer un RDV par simple clic (via l'état Zustand)
- Les données sont persistées en base PostgreSQL via Prisma
[Source: docs/prd.md - Section 4]

### User Story PRD
- US.1: En tant que praticien, je veux gérer mes disponibilités pour que les patients ne réservent que sur mes heures de travail.
[Source: docs/prd.md - Section 3]

### Design System
- **Modals**: Pour les formulaires de création sans quitter le contexte actuel
- Couleur principale bouton: Blue-600 (#2563eb)
- Couleur danger (annuler/supprimer): Rose-500
[Source: docs/front-end-spec/2-design-system-ui-components.md]

### Schéma Prisma Appointment
```prisma
model Appointment {
  id        String   @id @default(uuid())
  patientId String
  patient   Patient  @relation(fields: [patientId], references: [id])
  dateTime  DateTime
  duration  Int      // en minutes
  status    AppointmentStatus @default(PENDING)
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum AppointmentStatus {
  PENDING
  CONFIRMED
  CANCELLED
}
```
[Source: Story 1.2 - Couche de Données]

### Algorithme de détection de conflit
```typescript
const checkConflict = async (dateTime: Date, duration: number, excludeId?: string) => {
  const endTime = addMinutes(dateTime, duration)
  
  const conflict = await prisma.appointment.findFirst({
    where: {
      id: excludeId ? { not: excludeId } : undefined,
      status: { not: 'CANCELLED' },
      OR: [
        // Nouveau RDV commence pendant un existant
        { dateTime: { lte: dateTime }, endTime: { gt: dateTime } },
        // Nouveau RDV finit pendant un existant  
        { dateTime: { lt: endTime }, endTime: { gte: endTime } },
        // Nouveau RDV englobe un existant
        { dateTime: { gte: dateTime }, endTime: { lte: endTime } },
      ],
    },
  })
  
  return { hasConflict: !!conflict, conflictingAppointment: conflict }
}
```

### Testing
- Tester la création de RDV sur un créneau vide
- Vérifier la détection de conflit avec RDV existant
- Tester la modification de statut
- Vérifier la mise à jour instantanée de l'agenda
- Tester la suppression avec confirmation

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-25 | 1.0 | Création initiale de la story | SM Agent (Bob) |
