# Story 5.2: Sécurisation & Tests

## Status
Draft

## Story
**As a** praticien,
**I want** que toutes les actions sensibles soient sécurisées et vérifiées,
**so that** les données de mes patients restent protégées et l'application fonctionne de manière fiable.

## Acceptance Criteria
1. Toutes les Server Actions du dashboard vérifient l'authentification
2. Les Server Actions vérifient que l'utilisateur a le droit d'accéder/modifier les données
3. Les données sensibles (email, téléphone) sont protégées contre les injections
4. Des tests de bout en bout couvrent le flux de réservation invité
5. Des tests de bout en bout couvrent le flux de connexion praticien
6. Les tests vérifient la protection des routes `/dashboard/*`
7. Un rapport de test est généré après exécution

## Tasks / Subtasks
- [ ] Task 1: Middleware d'authentification renforcé (AC: 1, 6)
  - [ ] Vérifier que le middleware couvre toutes les routes `/dashboard/*`
  - [ ] Ajouter la vérification de session expirée
  - [ ] Logger les tentatives d'accès non autorisées
  - [ ] Tester les redirections vers `/login`
- [ ] Task 2: Protection des Server Actions (AC: 1, 2)
  - [ ] Créer un wrapper `withAuth` pour les Server Actions:
    ```typescript
    const withAuth = async (action: () => Promise<any>) => {
      const session = await getServerSession()
      if (!session) throw new Error('Unauthorized')
      return action()
    }
    ```
  - [ ] Appliquer `withAuth` à toutes les actions du dashboard:
    - createPatient, updatePatient, deletePatient
    - createAppointment, updateAppointment, deleteAppointment
    - getPatients, getAppointments
- [ ] Task 3: Validation et sanitization (AC: 3)
  - [ ] Vérifier que tous les schémas Zod sont appliqués côté serveur
  - [ ] Ajouter des règles de sanitization:
    - Trim des espaces blancs
    - Échappement des caractères spéciaux pour les recherches
  - [ ] Protéger contre les injections SQL (Prisma le fait par défaut)
  - [ ] Valider les UUIDs avant les requêtes
- [ ] Task 4: Setup tests E2E (AC: 4, 5, 7)
  - [ ] Installer Playwright: `npm install -D @playwright/test`
  - [ ] Configurer `playwright.config.ts`
  - [ ] Créer le dossier `/tests/e2e/`
  - [ ] Créer les fixtures de données de test
- [ ] Task 5: Tests E2E - Flux invité (AC: 4)
  - [ ] Créer `/tests/e2e/guest-booking.spec.ts`
  - [ ] Test: accès page de réservation
  - [ ] Test: sélection d'un créneau
  - [ ] Test: remplissage formulaire invité
  - [ ] Test: validation des erreurs de formulaire
  - [ ] Test: confirmation et écran de succès
- [ ] Task 6: Tests E2E - Flux praticien (AC: 5, 6)
  - [ ] Créer `/tests/e2e/practitioner-auth.spec.ts`
  - [ ] Test: connexion avec identifiants valides
  - [ ] Test: rejet avec identifiants invalides
  - [ ] Test: accès dashboard après connexion
  - [ ] Test: redirection si non authentifié
  - [ ] Test: déconnexion
- [ ] Task 7: Tests E2E - Protection routes (AC: 6)
  - [ ] Test: accès direct `/dashboard` sans auth → redirection
  - [ ] Test: accès direct `/dashboard/patients` sans auth → redirection
  - [ ] Test: accès direct `/dashboard/calendar` sans auth → redirection
- [ ] Task 8: Rapport de tests (AC: 7)
  - [ ] Configurer le reporter HTML de Playwright
  - [ ] Ajouter script npm: `"test:e2e": "playwright test"`
  - [ ] Ajouter script npm: `"test:e2e:report": "playwright show-report"`
  - [ ] Documenter la procédure de lancement des tests

## Dev Notes

### Sécurité Server Actions
Toutes les Server Actions du dashboard doivent vérifier l'authentification. Pattern recommandé:

```typescript
'use server'

import { createServerComponentClient } from '@supabase/auth-helpers-nextjs'
import { cookies } from 'next/headers'

async function getAuthenticatedUser() {
  const supabase = createServerComponentClient({ cookies })
  const { data: { session } } = await supabase.auth.getSession()
  
  if (!session) {
    throw new Error('Non authentifié')
  }
  
  return session.user
}

export async function protectedAction(data: FormData) {
  const user = await getAuthenticatedUser()
  
  // Action sécurisée...
}
```

### Validation UUID
```typescript
import { z } from 'zod'

const uuidSchema = z.string().uuid()

export function validateUUID(id: string): boolean {
  return uuidSchema.safeParse(id).success
}
```

### Configuration Playwright
```typescript
// playwright.config.ts
import { defineConfig, devices } from '@playwright/test'

export default defineConfig({
  testDir: './tests/e2e',
  fullyParallel: true,
  forbidOnly: !!process.env.CI,
  retries: process.env.CI ? 2 : 0,
  workers: process.env.CI ? 1 : undefined,
  reporter: 'html',
  use: {
    baseURL: 'http://localhost:3000',
    trace: 'on-first-retry',
  },
  projects: [
    {
      name: 'chromium',
      use: { ...devices['Desktop Chrome'] },
    },
    {
      name: 'Mobile Safari',
      use: { ...devices['iPhone 12'] },
    },
  ],
  webServer: {
    command: 'npm run dev',
    url: 'http://localhost:3000',
    reuseExistingServer: !process.env.CI,
  },
})
```

### Exemple test E2E Playwright
```typescript
// tests/e2e/guest-booking.spec.ts
import { test, expect } from '@playwright/test'

test.describe('Flux de réservation invité', () => {
  test('devrait permettre de réserver un créneau', async ({ page }) => {
    await page.goto('/cabinet/book')
    
    // Sélectionner une date
    await page.click('[data-testid="date-selector"]')
    await page.click('[data-testid="date-option"]:first-child')
    
    // Sélectionner un créneau
    await page.click('[data-testid="slot"]:first-child')
    
    // Remplir le formulaire
    await page.fill('[name="firstName"]', 'Jean')
    await page.fill('[name="lastName"]', 'Dupont')
    await page.fill('[name="phone"]', '0612345678')
    await page.fill('[name="email"]', 'jean.dupont@test.com')
    
    // Soumettre
    await page.click('[data-testid="submit-booking"]')
    
    // Vérifier succès
    await expect(page).toHaveURL(/\/book\/success/)
    await expect(page.locator('[data-testid="success-message"]')).toBeVisible()
  })
})
```

### Testing
- Exécuter tous les tests E2E avec `npm run test:e2e`
- Vérifier le rapport HTML généré
- Tester sur Chrome et Safari mobile
- Vérifier la couverture des scénarios critiques

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-25 | 1.0 | Création initiale de la story | SM Agent (Bob) |
