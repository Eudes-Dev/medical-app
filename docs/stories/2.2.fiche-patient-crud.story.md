# Story 2.2: Fiche Patient & CRUD

## Status
Draft

## Story
**As a** praticien,
**I want** créer, modifier et consulter les fiches de mes patients,
**so that** je puisse maintenir une base de données patients complète et à jour.

## Acceptance Criteria
1. Un formulaire de création de patient est accessible via un bouton "Nouveau Patient"
2. Le formulaire contient les champs: Nom, Prénom, Téléphone, Email
3. La validation Zod vérifie tous les champs côté client et serveur
4. Le formulaire affiche les erreurs de validation sous chaque champ
5. La création réussie affiche un toast de succès et redirige vers la liste
6. La page `/dashboard/patients/[id]` affiche la fiche détaillée avec l'historique des RDV
7. Le mode édition permet de modifier les informations du patient
8. Une Server Action persiste les données en base PostgreSQL

## Tasks / Subtasks
- [ ] Task 1: Schéma de validation Zod (AC: 3)
  - [ ] Créer `/lib/validations/patient.ts`
  - [ ] Définir `patientSchema`:
    - lastName: string, min 2 caractères, requis
    - firstName: string, min 2 caractères, requis
    - phone: string, format téléphone français (10 chiffres)
    - email: string, format email valide, requis
- [ ] Task 2: Composant PatientForm (AC: 2, 4)
  - [ ] Créer `/components/patients/PatientForm.tsx`
  - [ ] Utiliser `react-hook-form` avec `zodResolver`
  - [ ] Ajouter les champs avec Shadcn UI (Input, Label, FormMessage)
  - [ ] Afficher les erreurs de validation inline
- [ ] Task 3: Modal de création (AC: 1)
  - [ ] Créer `/components/patients/CreatePatientModal.tsx`
  - [ ] Utiliser Shadcn Dialog ou Sheet
  - [ ] Intégrer le PatientForm
  - [ ] Ajouter le bouton "Nouveau Patient" dans la page patients
- [ ] Task 4: Server Actions CRUD (AC: 8)
  - [ ] Créer `createPatient(data)` - validation + insertion Prisma
  - [ ] Créer `updatePatient(id, data)` - validation + mise à jour Prisma
  - [ ] Créer `getPatientById(id)` - récupération avec historique RDV
  - [ ] Créer `deletePatient(id)` - suppression (soft delete optionnel)
- [ ] Task 5: Feedback utilisateur (AC: 5)
  - [ ] Installer `sonner` pour les toasts (compatible Shadcn)
  - [ ] Ajouter le Toaster dans le layout
  - [ ] Afficher toast succès après création/modification
  - [ ] Afficher toast erreur en cas d'échec
- [ ] Task 6: Page fiche patient (AC: 6)
  - [ ] Créer `/app/(dashboard)/dashboard/patients/[id]/page.tsx`
  - [ ] Afficher les informations du patient
  - [ ] Lister l'historique des rendez-vous (date, statut)
  - [ ] Ajouter un lien vers chaque RDV
- [ ] Task 7: Mode édition (AC: 7)
  - [ ] Ajouter un bouton "Modifier" sur la fiche patient
  - [ ] Réutiliser PatientForm en mode édition
  - [ ] Pré-remplir les champs avec les données existantes

## Dev Notes

### Stratégie de Validation (Zod)
- **Côté Client**: Feedback immédiat sous les champs de saisie (ex: format email, téléphone obligatoire)
- **Côté Serveur**: Double vérification dans les Next.js Server Actions avant insertion en base
[Source: docs/front-end-spec.md - Section 4]

### Logique de Données
- **Relations**: Patient (1) <---> (N) Appointment
- **Accès**: Couche de services via Next.js Server Actions
[Source: docs/architecture/2-logique-de-donnes.md]

### Design System
- Utiliser les composants Shadcn UI (Input, Button, Dialog, Form)
- Modals pour les formulaires de création de patient sans quitter le contexte actuel
- Couleur d'erreur: Rose-500 pour les messages de validation
[Source: docs/front-end-spec/2-design-system-ui-components.md]

### Schéma Prisma Patient
```prisma
model Patient {
  id        String   @id @default(uuid())
  firstName String
  lastName  String
  phone     String
  email     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  appointments Appointment[]
}
```
[Source: Story 1.2 - Couche de Données]

### Exemple Server Action
```typescript
'use server'

import { prisma } from '@/lib/prisma'
import { patientSchema } from '@/lib/validations/patient'
import { revalidatePath } from 'next/cache'

export async function createPatient(formData: FormData) {
  const data = Object.fromEntries(formData)
  const validated = patientSchema.safeParse(data)
  
  if (!validated.success) {
    return { error: validated.error.flatten() }
  }
  
  const patient = await prisma.patient.create({
    data: validated.data
  })
  
  revalidatePath('/dashboard/patients')
  return { success: true, patient }
}
```

### Testing
- Tester la création avec des données valides
- Tester la validation avec des données invalides (email mal formaté, champs vides)
- Vérifier l'affichage des erreurs de validation
- Tester la modification d'un patient existant
- Vérifier l'affichage des toasts

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-25 | 1.0 | Création initiale de la story | SM Agent (Bob) |
