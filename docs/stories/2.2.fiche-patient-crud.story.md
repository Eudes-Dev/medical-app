# Story 2.2: Fiche Patient & CRUD

## Status
Ready for Review

## Story
**As a** praticien,
**I want** pouvoir créer, modifier et consulter les fiches de mes patients,
**so that** je puisse maintenir une base de données patients complète et à jour.

## Acceptance Criteria
1. Un formulaire de création de patient est accessible via un bouton "Nouveau Patient"
2. Le formulaire contient les champs : Nom, Prénom, Téléphone, Email (optionnel)
3. La validation Zod vérifie tous les champs côté client et serveur
4. Le formulaire affiche les erreurs de validation sous chaque champ
5. La création réussie affiche un toast de succès, ferme le modal et revalide la liste
6. La page `/dashboard/patients/[id]` affiche la fiche détaillée avec l'historique des RDV
7. Le mode édition permet de modifier les informations du patient
8. Une Server Action persiste les données en base PostgreSQL

## Tasks / Subtasks
- [x] Task 1: Schéma de validation Zod (AC: 3)
  - [x] Étendre `/lib/validations/patients.ts` (fichier existant, cf. story 2.1)
  - [x] Définir `patientSchema` :
    - lastName: string, min 2 caractères, requis
    - firstName: string, min 2 caractères, requis
    - phone: string, format téléphone français (10 chiffres), requis
    - email: string, format email valide, optionnel (aligné avec Prisma `email String?`)
- [x] Task 2: Composant PatientForm (AC: 2, 4)
  - [x] Créer `/components/patients/patient-form.tsx`
  - [x] Utiliser `react-hook-form` avec `zodResolver`
  - [x] Ajouter les champs avec Shadcn UI (Input, Label, FormMessage ; ajouter `form` si absent : `npx shadcn add form`)
  - [x] Afficher les erreurs de validation inline
- [x] Task 3: Modal de création (AC: 1)
  - [x] Créer `/components/patients/create-pient-modal.tsx`
  - [x] Utiliser Shadcn Sheet (composant présent ; Dialog disponible via Radix si préféré)
  - [x] Intégrer le `PatientForm`
  - [x] Modifier le bouton "Nouveau Patient" existant (page `/dashboard/patients`) : ouvrir le modal au lieu du lien vers `/dashboard/patients/new`
- [x] Task 4: Server Actions CRUD (AC: 8)
  - [x] Dans `/app/dashboard/patients/actions.ts` : ajouter `createPatient(data)`, `updatePatient(id, data)`, `getPatientById(id)`, `deletePatient(id)`
  - [x] `createPatient` / `updatePatient` : validation via `patientSchema` puis insertion/mise à jour Prisma
  - [x] `getPatientById` : récupération avec `include: { appointments: true }` (date, statut, lien)
  - [x] `deletePatient` : suppression en base (hard delete ; soft delete hors périmètre)
- [x] Task 5: Feedback utilisateur (AC: 5)
  - [x] Installer `sonner` et ajouter le `Toaster` dans le layout (ex. `app/layout.tsx` ou layout dashboard)
  - [x] Toast succès après création/modification ; toast erreur en cas d'échec
- [x] Task 6: Page fiche patient (AC: 6)
  - [x] Créer `/app/dashboard/patients/[id]/page.tsx`
  - [x] Afficher les informations du patient
  - [x] Lister l'historique des rendez-vous (date, statut) avec lien vers chaque RDV
- [x] Task 7: Mode édition (AC: 7)
  - [x] Bouton "Modifier" sur la fiche patient ; réutiliser `PatientForm` en mode édition
  - [x] Pré-remplir les champs avec les données existantes

## Dev Notes

### Stratégie de Validation (Zod)
- **Côté Client**: Feedback immédiat sous les champs de saisie (ex: format email, téléphone obligatoire)
- **Côté Serveur**: Double vérification dans les Next.js Server Actions avant insertion en base
[Source: docs/front-end-spec.md - Section 4]

### Logique de Données
- **Relations**: Patient (1) <---> (N) Appointment
- **Accès**: Couche de services via Next.js Server Actions
[Source: docs/architecture/2-logique-de-donnes.md]

### Design System
- Utiliser les composants Shadcn UI (Input, Button, Sheet/Dialog, Form)
- Modals pour les formulaires de création de patient sans quitter le contexte actuel
- Couleur d'erreur: Rose-500 pour les messages de validation
[Source: docs/front-end-spec.md §2, docs/front-end-spec/2-design-system-ui-components.md]

### Schéma Prisma Patient
Voir `prisma/schema.prisma`. Résumé pertinent :
- `id`, `firstName`, `lastName`, `phone`, `email?`, `createdAt`, `updatedAt`, `appointments`
- `email` est **optionnel** (`String?`) ; pas de `@unique` explicite sur email.
- Champs mappés en snake_case en base (`@map("first_name")`, etc.).
[Source: prisma/schema.prisma, docs/architecture/2-logique-de-donnes.md]

### Exemple Server Action (createPatient)
Les Server Actions reçoivent un objet (ex. depuis `react-hook-form`), pas `FormData`. Valider avec `patientSchema` puis insérer :

```typescript
'use server'

import { prisma } from '@/lib/prisma'
import { patientSchema } from '@/lib/validations/patients'
import { revalidatePath } from 'next/cache'

export async function createPatient(data: unknown) {
  const validated = patientSchema.safeParse(data)
  if (!validated.success) {
    return { error: validated.error.flatten() }
  }
  const patient = await prisma.patient.create({ data: validated.data })
  revalidatePath('/dashboard/patients')
  return { success: true, patient }
}
```
Vérifier l’auth (ex. Supabase) comme dans `getPatients` ; gérer les erreurs Prisma (ex. email dupliqué si contrainte).

### Testing
- **Emplacement** : `tests/` (unit : `tests/unit/`, e2e : `tests/e2e/`, integration : `tests/integration/`). Suivre la structure de la story 2.1 (ex. `tests/integration/patients/actions.test.ts`).
- **Outils** : Vitest, React Testing Library, éventuellement Playwright pour E2E (voir docs/qa).
- **Scénarios** : création avec données valides ; validation avec données invalides (email mal formaté, champs vides) ; affichage des erreurs de validation ; modification d’un patient existant ; affichage des toasts.

## Dev Agent Record

### Agent Model Used
- GPT-5.1 (Cursor DEV agent)

### Debug Log References
- Implémentation `patientSchema` et types associés dans `lib/validations/patients.ts`
- Mise en place des Server Actions CRUD patients dans `app/dashboard/patients/actions.ts` (création, mise à jour, suppression, lecture détaillée)
- Intégration du `PatientForm` et du modal de création dans la page `/dashboard/patients`
- Création de la fiche patient `/dashboard/patients/[id]` avec historique de rendez-vous et mode édition

### Completion Notes List
- Validation Zod mise en place côté client (react-hook-form + zodResolver) et côté serveur (Server Actions) pour tous les champs du patient.
- Le flux de création utilise un modal `Sheet` Shadcn avec toasts de succès/erreur et revalidation de la liste des patients.
- La fiche patient affiche les informations principales, l'historique des rendez-vous et permet la modification/suppression du patient avec feedback utilisateur.

### File List
- `lib/validations/patients.ts` (ajout de `patientSchema` et du type `PatientFormValues`)
- `components/ui/form.tsx` (nouveaux composants de formulaire génériques basés sur react-hook-form)
- `components/patients/patient-form.tsx` (formulaire réutilisable de création/édition de patient)
- `components/patients/create-patient-modal.tsx` (modal de création de patient avec intégration du formulaire et des toasts)
- `components/patients/patient-detail.tsx` (fiche patient client avec mode édition et historique des RDV)
- `components/ui/sonner.tsx` (wrapper `Toaster` + `toast` pour la librairie sonner)
- `app/layout.tsx` (intégration du composant `Toaster` global)
- `app/dashboard/patients/actions.ts` (Server Actions `getPatients`, `createPatient`, `updatePatient`, `getPatientById`, `deletePatient`)
- `app/dashboard/patients/page.tsx` (remplacement du lien "Nouveau Patient" par le `CreatePatientModal`)
- `app/dashboard/patients/[id]/page.tsx` (nouvelle page de fiche patient)

## QA Results

### Exécution des tests (2026-01-29)

- **Test design** : `docs/qa/assessments/2.2-test-design-20260129.md`
- **Gate** : `docs/qa/gates/2.2-fiche-patient-crud.yml` — **PASS**

**Tests exécutés (Story 2.2) :**

| Niveau       | Fichier                                      | Résultat        |
| ------------ | --------------------------------------------- | --------------- |
| Unit         | `tests/unit/validations/patients.test.ts`     | 12 tests ✓      |
| Integration  | `tests/integration/patients/actions.test.ts`  | 13 tests 2.2 ✓  |

**Scénarios couverts :**

- **2.2-UNIT-001 à 2.2-UNIT-005** : validation Zod (patientSchema) — nom, prénom, téléphone 10 chiffres, email optionnel/invalide.
- **2.2-INT-001, 2.2-INT-002** : createPatient / updatePatient retournent erreur si données invalides.
- **2.2-INT-003, 2.2-INT-004** : createPatient crée en base et appelle revalidatePath.
- **2.2-INT-005, 2.2-INT-006, 2.2-INT-007** : getPatientById retourne patient + appointments, lève UnauthorizedError si non auth, retourne null si id inexistant.
- **2.2-INT-008, 2.2-INT-009** : updatePatient met à jour en base et revalide les paths.
- **2.2-INT-010, 2.2-INT-011** : deletePatient supprime et retourne success ; retourne erreur si non authentifié.

**Non exécutés (E2E)** : 2.2-E2E-001 à 2.2-E2E-004 (modal, fiche, édition) — à couvrir avec Playwright ou tests composant si besoin.

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-25 | 1.0 | Création initiale de la story | SM Agent (Bob) |
| 2026-01-29 | 1.1 | Validation PO : alignement Prisma/schéma, paths, modal vs lien, nommage kebab-case, sections template (Dev Agent Record, QA Results), Dev Notes et AC corrigés | PO Agent (Sarah) |
