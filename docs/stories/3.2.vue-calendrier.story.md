# Story 3.2: Vue Calendrier

## Status
Approved

## Story
**As a** praticien,
**I want to** voir mon agenda sous forme de grille interactive,
**so that** je puisse visualiser mes rendez-vous et gérer mon planning quotidien.

## Acceptance Criteria
1. La page `/dashboard/calendar` affiche une grille calendrier
2. La vue Semaine affiche les 7 jours avec les créneaux horaires (8h-20h)
3. La vue Jour affiche une colonne avec les créneaux horaires détaillés
4. Les rendez-vous existants s'affichent sur les créneaux correspondants
5. Les rendez-vous affichent: nom du patient, heure, durée, statut (couleur)
6. La navigation permet de changer de semaine/jour avec les boutons précédent/suivant
7. Un bouton "Aujourd'hui" ramène à la date courante
8. La grille est responsive (adaptée mobile et desktop)

## Tasks / Subtasks
- [x] Task 1: Structure de la page calendrier (AC: 1)
  - [x] Créer `/app/dashboard/calendar/page.tsx`
  - [x] Créer un composant `CalendarHeader` avec:
    - Titre de la période (ex: "Semaine du 20 janvier 2026")
    - Boutons navigation (précédent, aujourd'hui, suivant)
    - Sélecteur de vue (jour/semaine)
- [x] Task 2: Composant CalendarGrid (AC: 2, 3)
  - [x] Créer `/components/calendar/CalendarGrid.tsx`
  - [x] Implémenter une grille CSS custom (grid-template)
  - [x] Axe vertical: heures de 8h à 20h (créneaux de 30min)
  - [x] Axe horizontal: jours (1 pour vue jour, 7 pour vue semaine)
  - [x] Afficher les lignes de séparation des heures
- [x] Task 3: Server Action pour les rendez-vous (AC: 4)
  - [x] Créer `/app/dashboard/calendar/actions.ts`
  - [x] Implémenter `getAppointmentsByDateRange(startDate, endDate)`
  - [x] Inclure les données patient (nom, prénom)
  - [x] Filtrer par statut si `showCancelled` est false
- [x] Task 4: Composant AppointmentCard (AC: 5)
  - [x] Créer `/components/calendar/AppointmentCard.tsx`
  - [x] Afficher: nom patient, heure début, durée
  - [x] Appliquer la couleur selon le statut:
    - CONFIRMED: Emerald-500
    - PENDING: Amber-500
    - CANCELLED: Rose-500 (si affiché)
  - [x] Calculer la hauteur selon la durée
  - [x] Positionner verticalement selon l'heure de début
- [x] Task 5: Intégration Zustand (AC: 6, 7)
  - [x] Utiliser `useCalendarStore` pour:
    - Lire `pivotDate` et `viewMode`
    - Appeler `goToNext()`, `goToPrevious()`, `goToToday()`
  - [x] Déclencher le fetch des rendez-vous quand pivotDate change
  - [x] Utiliser le cache si disponible
- [x] Task 6: Responsive Design (AC: 8)
  - [x] Sur mobile: vue jour par défaut, swipe pour changer de jour
  - [x] Sur desktop: vue semaine avec colonnes égales
  - [x] Utiliser les media queries Tailwind (sm, md, lg)
  - [x] Drawer (Vaul) sur mobile pour les détails du RDV

## Dev Notes

### Architecture de l'Information
- `/dashboard/calendar`: Agenda interactif. Cette story couvre les vues **jour** et **semaine** uniquement ; la vue mois reste hors périmètre.
[Source: docs/front-end-spec/1-architecture-de-linformation-sitemap.md]

### Gestion d'État (Zustand)
Le store `useCalendarStore` gère:
- La date pivot de l'affichage
- Les filtres de vue (ex: masquer les RDV annulés)
- Le cache local pour permettre des transitions instantanées entre les jours
[Source: docs/architecture/3-gestion-dtat-zustand.md]

### Design System - Composants Clés
- **Calendar Engine**: Basé sur une grille CSS custom pour une fluidité maximale sur desktop et mobile
- **Drawer (Vaul)**: Utilisé sur mobile pour la prise de RDV rapide
[Source: docs/front-end-spec/2-design-system-ui-components.md]

### Palette de couleurs pour les statuts
- **Succès (CONFIRMED)**: Emerald-500 - Rendez-vous confirmés
- **Alerte (PENDING)**: Amber-500 - En attente ou modification
- **Erreur (CANCELLED)**: Rose-500 - Annulations
[Source: docs/front-end-spec/2-design-system-ui-components.md]

### Calcul de position CSS
```typescript
// Calcul de la position verticale (top) en pourcentage
const calculateTop = (dateTime: Date) => {
  const hours = dateTime.getHours()
  const minutes = dateTime.getMinutes()
  const totalMinutes = (hours - 8) * 60 + minutes // 8h = début
  const percentage = (totalMinutes / (12 * 60)) * 100 // 12h de plage
  return `${percentage}%`
}

// Calcul de la hauteur selon durée
const calculateHeight = (durationMinutes: number) => {
  const percentage = (durationMinutes / (12 * 60)) * 100
  return `${percentage}%`
}
```

### Testing
- Vérifier l'affichage correct des rendez-vous aux bons créneaux
- Tester la navigation entre les semaines/jours
- Vérifier les couleurs selon le statut
- Tester le responsive sur différentes tailles d'écran
- Vérifier le chargement depuis le cache Zustand

## Dev Agent Record
*(À remplir par l’agent de développement pendant l’implémentation.)*

### Agent Model Used
*{{agent_model_name_version}}*

### Debug Log References
*Références aux logs de debug le cas échéant.*

### Completion Notes List
- Page calendrier avec CalendarHeader (titre période, navigation, sélecteur jour/semaine).
- CalendarGrid: grille CSS 8h–20h, 30 min, 1 ou 7 colonnes selon viewMode.
- Server Action getAppointmentsByDateRange avec filtre showCancelled et include patient.
- AppointmentCard: position top/height en %, couleurs CONFIRMED=Emerald, PENDING=Amber, CANCELLED=Rose.
- Zustand: cache par clé getCacheKeyForView, fetch si cache vide.
- Responsive: header empilé sur mobile (sm:flex-row), grille scroll horizontal; détail RDV en Sheet side=bottom (drawer mobile). Vue jour/semaine choisie par l’utilisateur (pas de forçage vue jour sur mobile pour ne pas écraser la préférence persistée).

### File List
- `app/dashboard/calendar/page.tsx` (créé)
- `app/dashboard/calendar/actions.ts` (créé)
- `components/calendar/CalendarHeader.tsx` (créé)
- `components/calendar/CalendarGrid.tsx` (créé)
- `components/calendar/AppointmentCard.tsx` (créé)

## QA Results
*(Résultats de la revue QA après implémentation.)*

**Date :** 2026-01-29  
**Reviewer :** Quinn (Test Architect)

**Gate :** PASS — [docs/qa/gates/3.2-vue-calendrier.yml](../qa/gates/3.2-vue-calendrier.yml)

**Test design :** [docs/qa/assessments/3.2-test-design-20260129.md](../qa/assessments/3.2-test-design-20260129.md) — 18 scénarios (5 unit, 9 integration, 4 e2e), P0: 8, P1: 8, P2: 2.

**Tests exécutés :**
- **Unit (calendar-utils) :** 21 tests passent (3.2-UNIT-001 à 3.2-UNIT-005 : calculateTop, calculateHeight, getDurationMinutes, getStatusBgClass, bornes).
- **Intégration (getAppointmentsByDateRange) :** 8 tests passent (3.2-INT-001 à 3.2-INT-008 : plage, patient, filtre showCancelled, auth, intersection).
- **E2E :** non exécutés (runner E2E calendrier à mettre en place ; recommandation future dans la gate).

**Couverture des AC :** AC1–AC8 couverts par le test design ; implémentation unit + integration couvre AC1–AC5, AC6–AC7 (store déjà testé en 3.1), AC8 (responsive : manuel/E2E).

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-29 | 1.1 | Validation PO : corrections et approbation | PO (Sarah) |
| 2026-01-25 | 1.0 | Création initiale de la story | SM Agent (Bob) |
