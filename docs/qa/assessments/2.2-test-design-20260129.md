# Test Design: Story 2.2 – Fiche Patient & CRUD

Date: 2026-01-29
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 18
- Unit tests: 5 (28%)
- Integration tests: 9 (50%)
- E2E tests: 4 (22%)
- Priority distribution: P0: 10, P1: 6, P2: 2

## Test Scenarios by Acceptance Criteria

### AC1: Un formulaire de création de patient est accessible via un bouton "Nouveau Patient"

| ID           | Level       | Priority | Test                                                | Justification                    |
| ------------ | ----------- | -------- | --------------------------------------------------- | -------------------------------- |
| 2.2-E2E-001  | E2E         | P1       | Clic sur "Nouveau Patient" ouvre le modal de création | Parcours utilisateur critique   |

### AC2: Le formulaire contient les champs : Nom, Prénom, Téléphone, Email (optionnel)

| ID           | Level       | Priority | Test                                                | Justification                    |
| ------------ | ----------- | -------- | --------------------------------------------------- | -------------------------------- |
| 2.2-UNIT-001 | Unit        | P0       | patientSchema valide les champs requis et optionnels | Logique de validation pure       |
| 2.2-UNIT-002 | Unit        | P0       | patientSchema rejette nom/prénom &lt; 2 caractères   | Règles métier                    |
| 2.2-UNIT-003 | Unit        | P0       | patientSchema valide le téléphone 10 chiffres       | Format téléphone FR              |
| 2.2-UNIT-004 | Unit        | P1       | patientSchema accepte email vide ou optionnel       | Alignement Prisma email?         |
| 2.2-UNIT-005 | Unit        | P0       | patientSchema rejette email invalide si fourni      | Validation format email         |

### AC3: La validation Zod vérifie tous les champs côté client et serveur

| ID           | Level       | Priority | Test                                                | Justification                    |
| ------------ | ----------- | -------- | --------------------------------------------------- | -------------------------------- |
| 2.2-INT-001  | Integration | P0       | createPatient retourne erreur si données invalides  | Validation côté Server Action    |
| 2.2-INT-002  | Integration | P0       | updatePatient retourne erreur si données invalides  | Validation côté Server Action    |

### AC4: Le formulaire affiche les erreurs de validation sous chaque champ

(Couvert par E2E ou tests composant si besoin ; pas de scénario dédié unit/int pour affichage UI.)

### AC5: La création réussie affiche un toast de succès, ferme le modal et revalide la liste

| ID           | Level       | Priority | Test                                                | Justification                    |
| ------------ | ----------- | -------- | --------------------------------------------------- | -------------------------------- |
| 2.2-INT-003  | Integration | P0       | createPatient avec données valides crée en base     | Persistance et retour success    |
| 2.2-INT-004  | Integration | P0       | createPatient appelle revalidatePath après création | Revalidation liste               |
| 2.2-E2E-002  | E2E         | P1       | Création réussie : toast + fermeture modal          | Parcours utilisateur             |

### AC6: La page `/dashboard/patients/[id]` affiche la fiche détaillée avec l'historique des RDV

| ID           | Level       | Priority | Test                                                | Justification                    |
| ------------ | ----------- | -------- | --------------------------------------------------- | -------------------------------- |
| 2.2-INT-005  | Integration | P0       | getPatientById retourne patient avec appointments   | Données fiche + historique       |
| 2.2-INT-006  | Integration | P0       | getPatientById lève UnauthorizedError si non auth   | Sécurité                         |
| 2.2-INT-007  | Integration | P1       | getPatientById retourne null si id inexistant      | Comportement attendu             |
| 2.2-E2E-003  | E2E         | P1       | Page [id] affiche fiche et liste des RDV           | Parcours utilisateur             |

### AC7: Le mode édition permet de modifier les informations du patient

| ID           | Level       | Priority | Test                                                | Justification                    |
| ------------ | ----------- | -------- | --------------------------------------------------- | -------------------------------- |
| 2.2-INT-008  | Integration | P0       | updatePatient met à jour le patient en base        | Persistance mise à jour          |
| 2.2-INT-009  | Integration | P0       | updatePatient appelle revalidatePath après mise à jour | Revalidation fiche + liste   |
| 2.2-E2E-004  | E2E         | P1       | Édition fiche : sauvegarde et feedback              | Parcours utilisateur             |

### AC8: Une Server Action persiste les données en base PostgreSQL

| ID           | Level       | Priority | Test                                                | Justification                    |
| ------------ | ----------- | -------- | --------------------------------------------------- | -------------------------------- |
| 2.2-INT-010  | Integration | P0       | deletePatient supprime le patient et retourne success | Persistance suppression      |
| 2.2-INT-011  | Integration | P0       | deletePatient retourne erreur si non authentifié   | Sécurité                         |

## Risk Coverage

- **Données invalides** : 2.2-UNIT-001 à 2.2-UNIT-005, 2.2-INT-001, 2.2-INT-002
- **Non authentifié** : 2.2-INT-006, 2.2-INT-011 ; createPatient/updatePatient retournent `{ success: false, error }` (pas d’exception)
- **Persistance** : 2.2-INT-003, 2.2-INT-004, 2.2-INT-008, 2.2-INT-009, 2.2-INT-010

## Recommended Execution Order

1. P0 Unit (patientSchema) : 2.2-UNIT-001 à 2.2-UNIT-003, 2.2-UNIT-005
2. P0 Integration : 2.2-INT-001 à 2.2-INT-006, 2.2-INT-008 à 2.2-INT-011
3. P1 Unit : 2.2-UNIT-004
4. P1 Integration : 2.2-INT-007
5. P1 E2E : 2.2-E2E-001 à 2.2-E2E-004
6. P2 si temps : scénarios secondaires

## Gate YAML Block (for quality gate)

```yaml
test_design:
  scenarios_total: 18
  by_level:
    unit: 5
    integration: 11
    e2e: 4
  by_priority:
    p0: 10
    p1: 6
    p2: 2
  coverage_gaps: []
```
