# Test Design: Story 3.3 – Gestion des Créneaux

Date: 2026-01-30
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 22
- Unit tests: 4 (validation Zod, utils)
- Integration tests: 12 (Server Actions: checkConflict, create, update, delete, status)
- E2E tests: 6 (modals, formulaire, conflit, détails, statuts)

**Justification des niveaux :** La validation formulaire (appointmentSchema) et les conversions date sont testables en unitaire. Les Server Actions (checkConflict, createAppointment, updateAppointment, deleteAppointment, updateAppointmentStatus) doivent être couvertes en intégration avec Prisma mocké. Les parcours utilisateur (clic créneau → modal création, sélection patient, conflit, détail RDV, modification statut) sont couverts en E2E.

## Traceabilité des critères d'acceptation (Given-When-Then)

### AC1: Un clic sur un créneau vide ouvre une modal de création de RDV

| ID           | Level | Priority | Given | When | Then |
| ------------ | ----- | -------- | ----- | ---- | ---- |
| 3.3-E2E-001  | E2E   | P0       | Utilisateur sur la page calendrier, vue jour ou semaine | Il clique sur un créneau vide (sans RDV) | La modal "Nouveau rendez-vous" s'ouvre avec la date/heure du créneau pré-remplies |

### AC2: La modal permet de sélectionner un patient existant ou d'en créer un nouveau

| ID           | Level | Priority | Given | When | Then |
| ------------ | ----- | -------- | ----- | ---- | ---- |
| 3.3-E2E-002  | E2E   | P0       | Modal de création ouverte | L'utilisateur tape un nom dans le champ Patient | Une liste de patients correspondants s'affiche ; il peut en sélectionner un |
| 3.3-E2E-003  | E2E   | P0       | Modal de création ouverte | L'utilisateur clique sur "Nouveau patient" | Le modal de création de patient s'ouvre ; après création le patient est pré-sélectionné dans le formulaire RDV |

### AC3: Le formulaire contient: patient, date/heure de début, durée, type de consultation, notes optionnelles

| ID           | Level | Priority | Given | When | Then |
| ------------ | ----- | -------- | ----- | ---- | ---- |
| 3.3-UNIT-001 | Unit  | P0       | Schéma Zod appointmentSchema | Données valides (patientId, startTime futur, duration 15/30/45/60, type, notes optionnel) | La validation réussit |
| 3.3-UNIT-002 | Unit  | P0       | Schéma Zod appointmentSchema | patientId vide ou startTime dans le passé ou duration invalide | La validation échoue avec messages d'erreur appropriés |
| 3.3-INT-001  | Integration | P0 | createAppointment avec données valides | Appel avec patientId, startTime, duration, type, notes | RDV créé en base (startTime, endTime, type, patientId, notes, status PENDING) ; revalidatePath appelé |

### AC4: Le système vérifie les conflits d'horaires avant validation

| ID           | Level | Priority | Given | When | Then |
| ------------ | ----- | -------- | ----- | ---- | ---- |
| 3.3-INT-002  | Integration | P0 | Aucun RDV sur le créneau [10h–10h30] | checkConflict(10h, 10h30) | hasConflict: false |
| 3.3-INT-003  | Integration | P0 | Un RDV existant 10h–10h30 (non CANCELLED) | checkConflict(10h, 10h30) | hasConflict: true, conflictingAppointment renseigné |
| 3.3-INT-004  | Integration | P0 | Un RDV existant 10h–10h30 | checkConflict(10h15, 10h45) (chevauchement partiel) | hasConflict: true |
| 3.3-INT-005  | Integration | P1 | Un RDV existant 10h–10h30 au statut CANCELLED | checkConflict(10h, 10h30) | hasConflict: false |

### AC5: Un message d'erreur s'affiche si le créneau est déjà occupé

| ID           | Level | Priority | Given | When | Then |
| ------------ | ----- | -------- | ----- | ---- | ---- |
| 3.3-INT-006  | Integration | P0 | Un RDV existant sur le créneau | createAppointment avec même plage | success: false, error contenant le nom du patient en conflit |
| 3.3-E2E-004  | E2E   | P1       | Un RDV déjà affiché sur un créneau | L'utilisateur remplit le formulaire pour ce créneau et soumet | Un toast d'erreur affiche que le créneau est occupé |

### AC6: La création réussie affiche un toast et met à jour l'agenda instantanément

| ID           | Level | Priority | Given | When | Then |
| ------------ | ----- | -------- | ----- | ---- | ---- |
| 3.3-INT-007  | Integration | P0 | Contexte auth, pas de conflit | createAppointment valide | Réponse success: true, appointment retourné ; revalidatePath appelé |
| 3.3-E2E-005  | E2E   | P1       | Modal création ouverte, formulaire valide | L'utilisateur soumet | Toast succès "Rendez-vous créé", modal se ferme, le nouveau RDV apparaît dans la grille |

### AC7: Un clic sur un RDV existant ouvre ses détails avec options de modification

| ID           | Level | Priority | Given | When | Then |
| ------------ | ----- | -------- | ----- | ---- | ---- |
| 3.3-E2E-006  | E2E   | P0       | Un RDV affiché dans la grille | L'utilisateur clique sur le RDV | Modal/Sheet détails s'ouvre avec patient (lien fiche), date/heure, durée, type, statut, notes ; boutons Modifier, Confirmer/Annuler/Terminer, Supprimer |

### AC8: Le praticien peut modifier le statut (confirmer, annuler, terminer) ou supprimer le RDV

| ID           | Level | Priority | Given | When | Then |
| ------------ | ----- | -------- | ----- | ---- | ---- |
| 3.3-INT-008  | Integration | P0 | RDV existant PENDING | updateAppointmentStatus(id, CONFIRMED) | Statut mis à jour en base ; revalidatePath appelé |
| 3.3-INT-009  | Integration | P0 | RDV existant | updateAppointmentStatus(id, CANCELLED) | Statut CANCELLED en base |
| 3.3-INT-010  | Integration | P0 | RDV existant | deleteAppointment(id) | RDV supprimé en base ; revalidatePath appelé |
| 3.3-INT-011  | Integration | P1 | RDV existant, startTime/duration modifiés sans chevauchement | updateAppointment(id, { startTime, duration }) | RDV mis à jour ; checkConflict appelé avec excludeId |
| 3.3-INT-012  | Integration | P1 | RDV existant, nouvelle plage en conflit avec un autre RDV | updateAppointment(id, { startTime, duration }) | success: false, message d'erreur conflit |
| 3.3-UNIT-003 | Unit  | P1 | Données formulaire invalides (notes > 500 car.) | appointmentSchema.parse | Erreur Zod "max 500 caractères" |

## Risk Coverage

- **Conflit d'horaires** : 3.3-INT-002 à 3.3-INT-006, 3.3-INT-011, 3.3-INT-012.
- **CRUD et statut** : 3.3-INT-001, 3.3-INT-007 à 3.3-INT-010.
- **Validation formulaire** : 3.3-UNIT-001, 3.3-UNIT-002, 3.3-UNIT-003.
- **Parcours utilisateur** : 3.3-E2E-001 à 3.3-E2E-006.

## Recommended Execution Order

1. P0 Unit : 3.3-UNIT-001, 3.3-UNIT-002.
2. P0 Integration : 3.3-INT-001, 3.3-INT-002, 3.3-INT-003, 3.3-INT-006, 3.3-INT-007, 3.3-INT-008, 3.3-INT-009, 3.3-INT-010.
3. P1 Integration : 3.3-INT-004, 3.3-INT-005, 3.3-INT-011, 3.3-INT-012.
4. P1 Unit : 3.3-UNIT-003.
5. E2E : 3.3-E2E-001 à 3.3-E2E-006 (après mise en place du runner E2E calendrier).

## Coverage Gaps (état actuel)

- **Aucun test automatisé spécifique à la story 3.3 n'est encore implémenté.** Les tests existants (calendar-utils, getAppointmentsByDateRange) couvrent la story 3.2. Les scénarios ci-dessus constituent le design de tests à implémenter pour valider la gestion des créneaux (création, conflits, modification, statuts, suppression).
