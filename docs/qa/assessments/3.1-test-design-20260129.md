# Test Design: Story 3.1 – State Management (Zustand)

Date: 2026-01-29
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 16
- Unit tests: 15 (94%)
- Integration tests: 0 (0%)
- E2E tests: 1 (6%)
- Priority distribution: P0: 10, P1: 5, P2: 1

**Justification des niveaux :** Le store Zustand est une logique d’état pure côté client (pas de DB, pas d’API). Les critères sont couverts par des tests unitaires. Un scénario E2E P2 optionnel valide la persistance des préférences après rechargement (Story 3.2 pourra couvrir le parcours calendrier complet).

## Test Scenarios by Acceptance Criteria

### AC1: Zustand est installé et configuré dans le projet

| ID           | Level | Priority | Test                                                | Justification                    |
| ------------ | ----- | -------- | --------------------------------------------------- | -------------------------------- |
| 3.1-UNIT-001 | Unit  | P2       | Le store useCalendarStore est importable et initialisable | Smoke : dépendance et config OK  |

### AC2: Le store useCalendarStore gère la date pivot (date actuellement affichée)

| ID           | Level | Priority | Test                                                | Justification                    |
| ------------ | ----- | -------- | --------------------------------------------------- | -------------------------------- |
| 3.1-UNIT-002 | Unit  | P0       | goToNext en mode day avance d’un jour               | Logique de navigation pure       |
| 3.1-UNIT-003 | Unit  | P0       | goToNext en mode week avance d’une semaine          | Idem                            |
| 3.1-UNIT-004 | Unit  | P0       | goToNext en mode month avance d’un mois             | Idem                            |
| 3.1-UNIT-005 | Unit  | P0       | goToPrevious en mode day recule d’un jour           | Idem                            |
| 3.1-UNIT-006 | Unit  | P0       | goToToday remet la date pivot au début du jour actuel | Comportement critique navigation |
| 3.1-UNIT-007 | Unit  | P0       | setDate définit la date pivot (début de jour)       | Point d’entrée navigation        |

### AC3: Le store gère les filtres de vue (jour, semaine, masquer annulés)

| ID           | Level | Priority | Test                                                | Justification                    |
| ------------ | ----- | -------- | --------------------------------------------------- | -------------------------------- |
| 3.1-UNIT-008 | Unit  | P0       | setViewMode change le mode (day, week, month)       | Logique de filtres pure          |
| 3.1-UNIT-009 | Unit  | P0       | toggleShowCancelled inverse showCancelled          | Idem                            |

### AC4: Le store maintient un cache local des rendez-vous chargés

| ID           | Level | Priority | Test                                                | Justification                    |
| ------------ | ----- | -------- | --------------------------------------------------- | -------------------------------- |
| 3.1-UNIT-010 | Unit  | P0       | setAppointments puis getAppointments retourne les RDV | Logique de cache pure            |
| 3.1-UNIT-011 | Unit  | P0       | getAppointments retourne null pour une clé absente  | Comportement attendu             |
| 3.1-UNIT-012 | Unit  | P0       | clearCache vide le cache                            | Invalidation après modification  |
| 3.1-UNIT-013 | Unit  | P1       | getCacheKeyForView retourne YYYY-MM-DD pour day    | Clés de cache cohérentes         |
| 3.1-UNIT-014 | Unit  | P1       | getCacheKeyForView retourne YYYY-Www pour week      | Idem                            |
| 3.1-UNIT-015 | Unit  | P1       | getCacheKeyForView retourne YYYY-MM pour month      | Idem                            |

### AC5: Les actions permettent de naviguer entre les dates (suivant, précédent, aujourd’hui)

Couvert par les scénarios AC2 (3.1-UNIT-002 à 3.1-UNIT-007).

### AC6: Le store est typé avec TypeScript

| ID           | Level | Priority | Test                                                | Justification                    |
| ------------ | ----- | -------- | --------------------------------------------------- | -------------------------------- |
| 3.1-UNIT-016 | Unit  | P1       | Compilation TypeScript sans erreur ; types exportés (ViewMode, CalendarState) | Typage statique vérifié par build |

Pas de scénario runtime dédié : la couverture des actions et de l’état dans les tests unitaires existants valide l’usage des types.

### AC7: La persistance locale optionnelle sauvegarde les préférences de vue

| ID           | Level | Priority | Test                                                | Justification                    |
| ------------ | ----- | -------- | --------------------------------------------------- | -------------------------------- |
| 3.1-UNIT-017 | Unit  | P1       | Persist partialize : seuls viewMode et showCancelled sont persistés (pas pivotDate ni cache) | Vérifiable via config du store + pas de persistance de pivotDate/cache |
| 3.1-E2E-001  | E2E   | P2       | Après changement viewMode/showCancelled et rechargement, les préférences sont restaurées | Parcours utilisateur optionnel  |

**Note :** 3.1-UNIT-017 est assuré par l’inspection du code (partialize) et par le fait que les tests nettoient localStorage entre chaque test pour éviter les fuites ; la persistance effective peut être validée en E2E (3.1-E2E-001) si un runner E2E est en place.

## Risk Coverage

- **Navigation incorrecte** : 3.1-UNIT-002 à 3.1-UNIT-007 (date pivot selon viewMode).
- **Filtres incohérents** : 3.1-UNIT-008, 3.1-UNIT-009.
- **Cache invalide ou clés incorrectes** : 3.1-UNIT-010 à 3.1-UNIT-015.
- **Persistance de données sensibles ou volatiles** : 3.1-UNIT-017 (partialize limité aux préférences).

## Recommended Execution Order

1. P0 Unit tests (navigation, filtres, cache) – fail fast
2. P1 Unit tests (getCacheKeyForView, typage, partialize)
3. P2 Unit (smoke store) puis E2E persistance si disponible

## Mapping avec les tests existants

| Scénario ID   | Fichier / describe/it actuel |
| -------------- | ----------------------------- |
| 3.1-UNIT-001   | Implicite (import + getState) |
| 3.1-UNIT-002   | navigation / goToNext avance d'un jour en mode day |
| 3.1-UNIT-003   | navigation / goToNext avance d'une semaine en mode week |
| 3.1-UNIT-004   | navigation / goToNext avance d'un mois en mode month |
| 3.1-UNIT-005   | navigation / goToPrevious recule d'un jour en mode day |
| 3.1-UNIT-006   | navigation / goToToday remet la date pivot… |
| 3.1-UNIT-007   | navigation / setDate définit la date pivot… |
| 3.1-UNIT-008   | filtres de vue / setViewMode change le mode… |
| 3.1-UNIT-009   | filtres de vue / toggleShowCancelled inverse… |
| 3.1-UNIT-010   | cache / setAppointments puis getAppointments… |
| 3.1-UNIT-011   | cache / getAppointments retourne null… |
| 3.1-UNIT-012   | cache / clearCache vide le cache |
| 3.1-UNIT-013–015 | getCacheKeyForView / day, week, month |
| 3.1-UNIT-016   | Vérification build TypeScript |
| 3.1-UNIT-017   | Revue de code partialize |
| 3.1-E2E-001    | À ajouter si E2E calendrier/préférences |

## Quality Checklist

- [x] Chaque AC a au moins un scénario de test
- [x] Niveaux adaptés (logique pure → unit)
- [x] Pas de doublon inutile entre niveaux
- [x] Priorités alignées (navigation/filtres/cache = P0/P1)
- [x] IDs au format 3.1-{LEVEL}-{SEQ}
- [x] Scénarios atomiques et indépendants

## Outputs pour gate

```yaml
test_design:
  scenarios_total: 16
  by_level:
    unit: 15
    integration: 0
    e2e: 1
  by_priority:
    p0: 10
    p1: 5
    p2: 1
  coverage_gaps: []
```

Test design matrix: docs/qa/assessments/3.1-test-design-20260129.md  
P0 tests identified: 10
